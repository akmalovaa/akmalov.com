<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Artur Akmalov Blog</title>
        <link>https://akmalov.com/blog</link>
        <description>Artur Akmalov Blog</description>
        <lastBuildDate>Sun, 27 Jul 2025 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>ru</language>
        <copyright>Copyright © 2025 Facebook, Inc.</copyright>
        <item>
            <title><![CDATA[MikroTik CPU Benchmark]]></title>
            <link>https://akmalov.com/blog/mikrotik-cpu-benchmark</link>
            <guid>https://akmalov.com/blog/mikrotik-cpu-benchmark</guid>
            <pubDate>Sun, 27 Jul 2025 00:00:00 GMT</pubDate>
            <description><![CDATA[Сравнение производительности CPU на устройствах MikroTik]]></description>
            <content:encoded><![CDATA[<p>CPU benchmark ipq-6010 vs 88f7040 сравнение производительности устройств MikroTik RB5009 vs hap ax3</p>
<p><a href="https://akmalov.com/blog/mikrotik-cpu-benchmark"><img decoding="async" loading="lazy" alt="mikrotik chr" src="https://akmalov.com/assets/images/logo-e4208a9f1f19736a2bf5aa854103d3b8.png" width="1201" height="470" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="введение">Введение<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5" class="hash-link" aria-label="Прямая ссылка на Введение" title="Прямая ссылка на Введение">​</a></h2>
<p>Возможность запускать контейнеры прямо на маршрутизаторах MikroTik открывает большие возможности, теперь ограничения только в фантазии и ресурсах железки</p>
<p>Если решите поиграть дома с контейнерами, то советую выбирать устройства:</p>
<ul>
<li><strong>ARM64</strong></li>
<li><strong>RAM</strong> &gt; 1Gb</li>
</ul>
<p>или использовать <strong>CHR VM</strong></p>
<p>На данный момент 2025 год и самые доступные для развлечений с контейнерами реальные железки это:</p>
<ul>
<li>hap ax2 (нет USB порта придется использовать сетевой диск)</li>
<li>hap ax3</li>
<li>RB5009</li>
</ul>
<p>По основным характеристикам все предлагаемые модели схожи, но имеют разные процессоры и хотелось бы сравнить их производительность (hap ax2 не смогу протестировать, данной модели нет под рукой, но и процессор там аналогичный ax3 - IPQ-6010)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="сравнение-cpu-mikrotik">Сравнение CPU MikroTik<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D1%81%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-cpu-mikrotik" class="hash-link" aria-label="Прямая ссылка на Сравнение CPU MikroTik" title="Прямая ссылка на Сравнение CPU MikroTik">​</a></h2>
<table><thead><tr><th>Property</th><th>RB5009UG</th><th>HAP AX^3</th><th>HAP AX^2</th></tr></thead><tbody><tr><td><strong>Product code</strong></td><td>RB5009UG+S+IN</td><td>C53UiG+5HPaxD2HPaxD</td><td>C52iG-5HaxD2HaxD-TC</td></tr><tr><td><strong>Architecture</strong></td><td>ARM 64bit</td><td>ARM 64bit</td><td>ARM 64bit</td></tr><tr><td><strong>CPU</strong></td><td>88F7040</td><td>IPQ-6010</td><td>IPQ-6010</td></tr><tr><td><strong>CPU core count</strong></td><td>4</td><td>4</td><td>4</td></tr><tr><td><strong>CPU nominal frequency</strong></td><td>350-1400 MHz</td><td>864 - 1800 MHz</td><td>864 - 1800 MHz</td></tr><tr><td><strong>Size of RAM</strong></td><td>1 GB</td><td>1 GB</td><td>1 GB</td></tr><tr><td><strong>Storage size</strong></td><td>1 GB</td><td>128 MB</td><td>128 MB</td></tr><tr><td><strong>IPsec hardware acceleration</strong></td><td>Yes</td><td>Yes</td><td>Yes</td></tr><tr><td><strong>Suggested price</strong></td><td>$219.00</td><td>$139.00</td><td>$99.00</td></tr></tbody></table>
<p>Для тестирования производительности CPU буду использовать контейнер с sysbench</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--rm</span><span class="token plain"> zyclonite/sysbench </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--test</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">cpu run</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--rm</span><span class="token plain"> zyclonite/sysbench </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--test</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">cpu </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--threads</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain"> run</span><br></span></code></pre></div></div>
<p>Установлена последняя версия на текущий момент: <code>RouterOS 7.19.3</code></p>
<p>Сначало проверим включен ли режим контейнеров</p>
<div class="language-routeros codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-routeros codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/system/device-mode/print </span><br></span></code></pre></div></div>
<p>Если нет, то включаем</p>
<div class="language-routeros codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-routeros codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/system/device-mode/update container=yes</span><br></span></code></pre></div></div>
<p>Краткая инструкция по настройке</p>
<div class="language-routeros codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-routeros codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Create bridge for containers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/interface/bridge/add name=br-container </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/ip/address/add address=10.200.0.1/24 interface=br-container </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Virtual Ethernet interface for Docker containers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/interface/veth/add name=veth1 address=10.200.0.10/24 gateway=10.200.0.1 </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/interface/bridge/port/add bridge=br-container interface=veth1 </span><br></span></code></pre></div></div>
<p>Cоздаем контейнер с sysbench</p>
<div class="language-routeros codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-routeros codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/add remote-image=mirror.gcr.io/zyclonite/sysbench cmd="--test=cpu --threads=1 run" interface=veth1 logging=yes name=sysbench root-dir=docker/sysbench </span><br></span></code></pre></div></div>
<p>Далее запускаем контейнер и смотрим результаты в логах</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rb5009---cpu-88f7040">RB5009 - CPU 88F7040<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#rb5009---cpu-88f7040" class="hash-link" aria-label="Прямая ссылка на RB5009 - CPU 88F7040" title="Прямая ссылка на RB5009 - CPU 88F7040">​</a></h3>
<p><a href="https://akmalov.com/assets/files/image-5009-23f2626d6d0e965f94e5cd918f4f18a8.png" target="_blank"><img decoding="async" loading="lazy" alt="RB5009" src="https://akmalov.com/assets/images/image-5009-23f2626d6d0e965f94e5cd918f4f18a8.png" width="3500" height="2200" class="img_ev3q"></a></p>
<p>sysbench</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 1276 events per second</span><br></span></code></pre></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 5093.27 events per second</span><br></span></code></pre></div></div>
<p><a href="https://akmalov.com/assets/files/cpu-5009-4f5f764801bf693503b963121f4f5036.png" target="_blank"><img decoding="async" loading="lazy" alt="CPU RB5009" src="https://akmalov.com/assets/images/cpu-5009-4f5f764801bf693503b963121f4f5036.png" width="932" height="526" class="img_ev3q"></a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hap-ax3---cpu-ipq-6010">HAP AX3 - CPU IPQ-6010<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#hap-ax3---cpu-ipq-6010" class="hash-link" aria-label="Прямая ссылка на HAP AX3 - CPU IPQ-6010" title="Прямая ссылка на HAP AX3 - CPU IPQ-6010">​</a></h3>
<p><a href="https://akmalov.com/assets/files/image-hap-ax3-006735e75aad4d126ad5952944f6e832.png" target="_blank"><img decoding="async" loading="lazy" alt="HAP AX3" src="https://akmalov.com/assets/images/image-hap-ax3-006735e75aad4d126ad5952944f6e832.png" width="3233" height="2613" class="img_ev3q"></a>
sysbench</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 841 events per second</span><br></span></code></pre></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 3347.89 events per second</span><br></span></code></pre></div></div>
<p><a href="https://akmalov.com/assets/files/cpu-hap-ax3-d3d8e9be23a88f20070ec0e27962d2dc.png" target="_blank"><img decoding="async" loading="lazy" alt="CPU HAP AX3" src="https://akmalov.com/assets/images/cpu-hap-ax3-d3d8e9be23a88f20070ec0e27962d2dc.png" width="868" height="512" class="img_ev3q"></a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chr-vps-red-hat-kvm-x86_64">CHR VPS Red Hat KVM x86_64<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#chr-vps-red-hat-kvm-x86_64" class="hash-link" aria-label="Прямая ссылка на CHR VPS Red Hat KVM x86_64" title="Прямая ссылка на CHR VPS Red Hat KVM x86_64">​</a></h3>
<p>Есть старая дешевая VPS от облачного провайдера, где запущен CHR несколько лет назад, до сих пор без проблем и сбоев работает, решил протестировать и ее тоже</p>
<ul>
<li><strong>CPU:</strong> 1 core (доп.инфо о процессоре не указано)</li>
<li><strong>RAM:</strong> 1 GB</li>
</ul>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 2491.79 events per second</span><br></span></code></pre></div></div>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-log codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">threads: 4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sysbench: CPU speed: 2483.32 events per second</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="сравнение-производительности-cpu-одноядерный-режим">Сравнение производительности CPU (одноядерный режим)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D1%81%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8-cpu-%D0%BE%D0%B4%D0%BD%D0%BE%D1%8F%D0%B4%D0%B5%D1%80%D0%BD%D1%8B%D0%B9-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC" class="hash-link" aria-label="Прямая ссылка на Сравнение производительности CPU (одноядерный режим)" title="Прямая ссылка на Сравнение производительности CPU (одноядерный режим)">​</a></h2>
<table><thead><tr><th>Device</th><th>CPU</th><th>Frequency</th><th>Events/sec</th><th>Relative performance</th></tr></thead><tbody><tr><td><strong>CHR VPS (KVM)</strong></td><td>x86_64</td><td>-</td><td><strong>2491.79</strong></td><td>100%</td></tr><tr><td><strong>RB5009UG+S+IN</strong></td><td>88F7040</td><td>350-1400 MHz</td><td><strong>1276</strong></td><td>51%</td></tr><tr><td><strong>HAP AX3</strong></td><td>IPQ-6010</td><td>864-1800 MHz</td><td><strong>841</strong></td><td>34%</td></tr></tbody></table>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CHR VPS (x86_64)    ████████████████████    2492 events/sec</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RB5009 (88F7040)    ██████████▍             1276 events/sec</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HAP AX3 (IPQ-6010)  ██████▾                 841 events/sec</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="сравнение-производительности-cpu-многоядерный-режим-4-потока">Сравнение производительности CPU (многоядерный режим, 4 потока)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D1%81%D1%80%D0%B0%D0%B2%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8-cpu-%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D1%8F%D0%B4%D0%B5%D1%80%D0%BD%D1%8B%D0%B9-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC-4-%D0%BF%D0%BE%D1%82%D0%BE%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Сравнение производительности CPU (многоядерный режим, 4 потока)" title="Прямая ссылка на Сравнение производительности CPU (многоядерный режим, 4 потока)">​</a></h2>
<table><thead><tr><th>Device</th><th>CPU</th><th>Threads</th><th>Events/sec</th><th>Relative performance</th></tr></thead><tbody><tr><td><strong>RB5009UG+S+IN</strong></td><td>88F7040</td><td>4</td><td><strong>5093</strong></td><td>100%</td></tr><tr><td><strong>HAP AX3</strong></td><td>IPQ-6010</td><td>4</td><td><strong>3348</strong></td><td>66%</td></tr><tr><td><strong>CHR VPS (KVM)</strong></td><td>x86_64</td><td>4</td><td><strong>2483.32</strong></td><td>49%</td></tr></tbody></table>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">RB5009 (88F7040)    ████████████████████    5093 events/sec</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HAP AX3 (IPQ-6010)  █████████████▎          3348 events/sec</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CHR VPS (x86_64)    █████████▾              2483 events/sec</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="выводы">Выводы<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D0%B2%D1%8B%D0%B2%D0%BE%D0%B4%D1%8B" class="hash-link" aria-label="Прямая ссылка на Выводы" title="Прямая ссылка на Выводы">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rb5009-88f7040">RB5009 (88F7040)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#rb5009-88f7040" class="hash-link" aria-label="Прямая ссылка на RB5009 (88F7040)" title="Прямая ссылка на RB5009 (88F7040)">​</a></h3>
<p>Лидерует, производительность выше чем HAP AX3 на 52%, но и цена дороже на 58%</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hap-ax3-ipq-6010">HAP AX3 (IPQ-6010)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#hap-ax3-ipq-6010" class="hash-link" aria-label="Прямая ссылка на HAP AX3 (IPQ-6010)" title="Прямая ссылка на HAP AX3 (IPQ-6010)">​</a></h3>
<p>Достойный результат, хорошее соотношение цена/производительность</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hap-ax2-ipq-6010">HAP AX2 (IPQ-6010)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#hap-ax2-ipq-6010" class="hash-link" aria-label="Прямая ссылка на HAP AX2 (IPQ-6010)" title="Прямая ссылка на HAP AX2 (IPQ-6010)">​</a></h3>
<p>Если учитывать что у модели hap ax2 процессор аналогичный</p>
<p>Лучшее соотношение цена/производительность, но нужно помнить что нет USB порта, для работы с контейнерами придется настраивать отдельное сетевое хранилище</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chr-vps-x86_64">CHR VPS (x86_64)<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#chr-vps-x86_64" class="hash-link" aria-label="Прямая ссылка на CHR VPS (x86_64)" title="Прямая ссылка на CHR VPS (x86_64)">​</a></h3>
<p>Тут производительность уже зависит от облачного хостинга и тарифа, имеется несколько VPS с CHR обычно использую самый минимальный тариф (1 core, 1 GB RAM), но производительность везде разная, на одном даже результат был примерно 753 (я сам в настройках что то упустил или облачный провайдер мутит)</p>
<p>Большой отрыв в одном потоке, но т.к. на моем тарифе доступно только одно ядро, то в многопоточном режиме уже проигрывает обычным железкам</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="о-контейнерах">О контейнерах<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#%D0%BE-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0%D1%85" class="hash-link" aria-label="Прямая ссылка на О контейнерах" title="Прямая ссылка на О контейнерах">​</a></h3>
<p>Больше информации на сайте MikroTik о контейнерах и их настройке <a href="https://help.mikrotik.com/docs/spaces/ROS/pages/84901929/Container" target="_blank" rel="noopener noreferrer">Container on MikroTik</a></p>
<p>Ролик на YouTube - <a href="https://www.youtube.com/watch?v=gfM1FvrWN18" target="_blank" rel="noopener noreferrer">Docker в Mikrotik</a></p>
<p>В целом начало уже положено, использовал чтоб поднять реверс прокси nginx и свои проекты для расширения возможностей маршрутизатора, работает стабильно.</p>
<p>На более ранних устройствах с 512Mb RAM и старыми версиями ARM не рекомендую, т.к. могут быть проблемы с памятью и производительностью и сборками. Пробовал на разных старых роутерах баловаться, есть нюансы и не все работает стабильно и предсказуемо.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sysbench">sysbench<a href="https://akmalov.com/blog/mikrotik-cpu-benchmark#sysbench" class="hash-link" aria-label="Прямая ссылка на sysbench" title="Прямая ссылка на sysbench">​</a></h2>
<p>Для сравенения другие устройства в <code>sysbench</code> threads=1</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--rm</span><span class="token plain"> zyclonite/sysbench </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--test</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">cpu </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--threads</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> run</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">- Intel N100:            2951.01</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- AMD Ryzen 5 5600G:     4711.98</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- AMD Ryzen 7 8745H:     5390.37</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">- Apple Mac Mini M4 16:  10459.80</span><br></span></code></pre></div></div>
<p>sysbench - имеет сильно больше возможностей и различных параметров, еще умеет сравнивать производительность памяти, дисков и т.д. В этих тестах использовал самое простое</p>]]></content:encoded>
            <category>homelab</category>
            <category>networks</category>
        </item>
        <item>
            <title><![CDATA[Mikrotik CHR cloud hosted router]]></title>
            <link>https://akmalov.com/blog/mikrotik-chr</link>
            <guid>https://akmalov.com/blog/mikrotik-chr</guid>
            <pubDate>Sun, 12 May 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[Mikrotik CHR Cloud Hosted Router install timeweb VPS]]></description>
            <content:encoded><![CDATA[<p>Установка Mikrotik Cloud Hosted Router на облачный сервер и для чего я его использую</p>
<p><a href="https://akmalov.com/blog/mikrotik-chr"><img decoding="async" loading="lazy" alt="mikrotik chr" src="https://akmalov.com/assets/images/logo-bca9c52c8617b3e673896b5bec7fcc75.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="введение">Введение<a href="https://akmalov.com/blog/mikrotik-chr#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5" class="hash-link" aria-label="Прямая ссылка на Введение" title="Прямая ссылка на Введение">​</a></h2>
<p>MikroTik Cloud Hosted Router (CHR) — специальная версия RouterOS, для работы в качестве виртуальной машины. Поддерживает архитектуру x86-64-разрядную и может использоваться на большинстве популярных гипервизоров, таких как VMware, Hyper-V, VirtualBox, KVM и т.д.</p>
<p>Системные требования CHR:</p>
<ul>
<li><strong>CPU:</strong> 64-bit with virtualization support</li>
<li><strong>RAM:</strong> &gt; 256MB</li>
<li><strong>Disk:</strong> &gt; 128MB (Max: 16GB)</li>
</ul>
<p>По умолчанию в CHR включены все функции RouterOS, но немного отличается модель лицензирования. Ограничения лицензии это скорость интерфейса наружу - 1 Мбит в бесплатной версии.</p>
<p><strong>Лицензии</strong></p>
<table><thead><tr><th>Название</th><th>Скорость</th><th>Цена</th></tr></thead><tbody><tr><td>Free</td><td>1 Mbit</td><td>Бесплатно</td></tr><tr><td>P1</td><td>1 Gbit</td><td>$45</td></tr><tr><td>P10</td><td>10 Gbit</td><td>$95</td></tr></tbody></table>
<p>Управлять лицензиями можно в личном кабинете на официальном сайте mikrotik.com</p>
<p>На Avito или специализированных группах telegram можно найти от 1000 рублей за P1</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="для-чего-использую-mikrotik-chr-в-облаке">Для чего использую Mikrotik CHR в облаке<a href="https://akmalov.com/blog/mikrotik-chr#%D0%B4%D0%BB%D1%8F-%D1%87%D0%B5%D0%B3%D0%BE-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D1%8E-mikrotik-chr-%D0%B2-%D0%BE%D0%B1%D0%BB%D0%B0%D0%BA%D0%B5" class="hash-link" aria-label="Прямая ссылка на Для чего использую Mikrotik CHR в облаке" title="Прямая ссылка на Для чего использую Mikrotik CHR в облаке">​</a></h2>
<p>Как внешний узел для распределения трафика</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="стандартная-схема">Стандартная схема<a href="https://akmalov.com/blog/mikrotik-chr#%D1%81%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%B0%D1%8F-%D1%81%D1%85%D0%B5%D0%BC%D0%B0" class="hash-link" aria-label="Прямая ссылка на Стандартная схема" title="Прямая ссылка на Стандартная схема">​</a></h3>
<p>Интернет + статичный белый IP адрес от провайдера приходит сразу на роутер, все в дом, а дальше трафик распределяется внутри</p>
<p><a href="https://akmalov.com/assets/files/scheme1.excalidraw-a2a49e7c5d5561fc25bf53a38b1319fd.png" target="_blank"><img decoding="async" loading="lazy" alt="scheme1" src="https://akmalov.com/assets/images/scheme1.excalidraw-a2a49e7c5d5561fc25bf53a38b1319fd.png" width="1600" height="1000" class="img_ev3q"></a></p>
<p><strong>Плюсы:</strong></p>
<ul>
<li>Нет никаких зависимых сервисов, провайдер направляет весь трафик напрямую на мое устройство</li>
</ul>
<p><strong>Минусы:</strong></p>
<ul>
<li>Цена 250 рублей в месяц за белый IP адрес</li>
<li>В случаи проблем со стороны провайдера, я завязан на выданный IP адрес и резервные интернет каналы не спасут от недоступности сервисов</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="схема-c-использованием-cloud-hosted-router">Схема c использованием Cloud Hosted Router<a href="https://akmalov.com/blog/mikrotik-chr#%D1%81%D1%85%D0%B5%D0%BC%D0%B0-c-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC-cloud-hosted-router" class="hash-link" aria-label="Прямая ссылка на Схема c использованием Cloud Hosted Router" title="Прямая ссылка на Схема c использованием Cloud Hosted Router">​</a></h3>
<p>Поднять RouterOS на облачном сервере, настроить VPN + IPsec сервер</p>
<p>Настроить подключение к домашней сети и распределение трафика</p>
<p><a href="https://akmalov.com/assets/files/scheme_chr.excalidraw-65ca3a4fb33149d829de7a65a5938320.png" target="_blank"><img decoding="async" loading="lazy" alt="scheme_chr" src="https://akmalov.com/assets/images/scheme_chr.excalidraw-65ca3a4fb33149d829de7a65a5938320.png" width="1720" height="1000" class="img_ev3q"></a></p>
<p><strong>Плюсы:</strong></p>
<ul>
<li>Цена VPS + статичный белый IP, дешевле чем просто IP адрес у моего провайдера, на timeweb сервер с <code>1 CPU, 1Gb RAM, 15GB NVMe</code> (таких ресурсов для роутера хватит с большим запасом) вышло 177 ₽/мес</li>
<li>Можно спокойно менять провайдера, поднимать резервные каналы связи</li>
<li>Еще одна ступень защиты (при грамотной настройке Firewall)</li>
<li>Остаются свободные ресурсы на сервере, можно еще что-то полезное поднять</li>
</ul>
<p><strong>Минусы:</strong></p>
<ul>
<li>Появляется еще одна сетевая точка отказа</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="схема-c-использованием-cloudflare-tunnel">Схема c использованием Cloudflare tunnel<a href="https://akmalov.com/blog/mikrotik-chr#%D1%81%D1%85%D0%B5%D0%BC%D0%B0-c-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC-cloudflare-tunnel" class="hash-link" aria-label="Прямая ссылка на Схема c использованием Cloudflare tunnel" title="Прямая ссылка на Схема c использованием Cloudflare tunnel">​</a></h3>
<p>Еще один вариант, DNS провайдер Cloudflare предоставляет возможность вообще не использовать белые IP адреса</p>
<p>Если доменное имя привязано к Cloudflare, можно использовать <code>Cloudflare Zero Trust</code> и внутри своего контура поднять сервис(службу) который будет поддерживать зашифрованный тунель с Cloudflare и перенаправлять домены на нужные адреса, берет на себя даже роль прокси сервера.</p>
<p><a href="https://akmalov.com/assets/files/scheme_cloudflare.excalidraw-869415cce781417750813dfcaa47c34e.png" target="_blank"><img decoding="async" loading="lazy" alt="scheme_cloudflare" src="https://akmalov.com/assets/images/scheme_cloudflare.excalidraw-869415cce781417750813dfcaa47c34e.png" width="1780" height="1000" class="img_ev3q"></a></p>
<p>Плюсы:</p>
<ul>
<li>Полностью бесплатна</li>
<li>Дополнительная защита от DDoS</li>
<li>Можно не использовать свой proxy сервер (для простых проектов)</li>
<li>Отсутствие привязки к IP адресам</li>
<li>Автоматическое использование SSL сертификата</li>
</ul>
<p>Минусы:</p>
<ul>
<li>Поднимать в своем контуре непонятный сервис и весь трафик гонять через него</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="установка-mikrotik-chr-в-облаке">Установка MikroTik CHR в облаке<a href="https://akmalov.com/blog/mikrotik-chr#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-mikrotik-chr-%D0%B2-%D0%BE%D0%B1%D0%BB%D0%B0%D0%BA%D0%B5" class="hash-link" aria-label="Прямая ссылка на Установка MikroTik CHR в облаке" title="Прямая ссылка на Установка MikroTik CHR в облаке">​</a></h2>
<p>В качестве примера буду использовать облака от <a href="https://timeweb.cloud/r/cp14436" target="_blank" rel="noopener noreferrer">timeweb</a></p>
<p>Создаю сервер <strong>Ubuntu</strong> и минимальными ресурсами</p>
<p><a href="https://akmalov.com/assets/files/chr_cloud_create-6b936a4391b81adb8f51e83d84f0730f.png" target="_blank"><img decoding="async" loading="lazy" alt="chr_cloud_create" src="https://akmalov.com/assets/images/chr_cloud_create-6b936a4391b81adb8f51e83d84f0730f.png" width="955" height="571" class="img_ev3q"></a></p>
<p>На созданном сервере поменять режим загрузки ОС для того, чтобы полностью остановить запись на диск <code>/dev/vda</code></p>
<p><a href="https://akmalov.com/assets/files/chr_cloud_create2-9ae00b9eaf9d1ae282b531f98d710c3a.png" target="_blank"><img decoding="async" loading="lazy" alt="chr_cloud_create2" src="https://akmalov.com/assets/images/chr_cloud_create2-9ae00b9eaf9d1ae282b531f98d710c3a.png" width="980" height="555" class="img_ev3q"></a></p>
<p><strong>Режим загрузки ОС</strong></p>
<p><strong>Выбрать тип:</strong> Загрузка с диска восстановления</p>
<p>Консоль SystemRescue (<strong>Ctrl + V</strong> работает)</p>
<p><a href="https://akmalov.com/assets/files/chr_install-ad3d75316f22068174a6dfe2a12e78f5.png" target="_blank"><img decoding="async" loading="lazy" alt="chr_install" src="https://akmalov.com/assets/images/chr_install-ad3d75316f22068174a6dfe2a12e78f5.png" width="978" height="433" class="img_ev3q"></a></p>
<p>На официальном сайте <a href="https://mikrotik.com/download" target="_blank" rel="noopener noreferrer">Mikrotik Software</a></p>
<p>Найти последнюю стабильную версию Cloud Hosted Router - <code>Raw disk image</code> и скопировать ссылку, вставить в терминале сервера восстановления (wget для скачивания образа)</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">wget</span><span class="token plain"> https://download.mikrotik.com/routeros/7.14.3/chr-7.14.3.img.zip</span><br></span></code></pre></div></div>
<p>Разархивировать образ:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">unzip</span><span class="token plain"> chr-7.14.3.img.zip</span><br></span></code></pre></div></div>
<p>Записать на диск <code>/dev/vda</code>:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">dd</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">if</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">chr-7.14.3.img </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">of</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/dev/vda</span><br></span></code></pre></div></div>
<p>Вернуть серверу стандартный режим загрузки и перезагрузить.</p>
<p>Для проверки подключиться с терминала или c winbox, пользователь <code>admin</code> пароль пустой.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Важно</div><div class="admonitionContent_BuS1"><p>Нужно сразу сменить пароль, иначе быстро придут боты, сами поменяют и настроят</p></div></div>
<p><a href="https://akmalov.com/assets/files/chr_winbox-bca1c7362ea379be5e0586570667f32b.png" target="_blank"><img decoding="async" loading="lazy" alt="chr_winbox" src="https://akmalov.com/assets/images/chr_winbox-bca1c7362ea379be5e0586570667f32b.png" width="964" height="558" class="img_ev3q"></a></p>
<blockquote>
<p>Логи: что будет если медлить с паролем или установить простой</p>
</blockquote>
<p>Быстро подберут пароль, добавят своего пользователя, включат все сервисы для подключения, admin-скую сместят в правах и добавят данное устройства в сеть автоботов для восстания машин</p>
<p><a href="https://akmalov.com/assets/files/chr_hacked-bc874a5a54bfbc7b5abd52ca78183a6e.png" target="_blank"><img decoding="async" loading="lazy" alt="chr_hacked" src="https://akmalov.com/assets/images/chr_hacked-bc874a5a54bfbc7b5abd52ca78183a6e.png" width="1099" height="567" class="img_ev3q"></a></p>
<p>Идет постоянное сканирование портов: <code>22,23,8291,8022,8728,8729</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="настройка-chr">Настройка CHR<a href="https://akmalov.com/blog/mikrotik-chr#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-chr" class="hash-link" aria-label="Прямая ссылка на Настройка CHR" title="Прямая ссылка на Настройка CHR">​</a></h2>
<p>Первым делом базовые настройки безопасности</p>
<p>Чек лист:</p>
<ul>
<li>Создать нового пользователя с полными правами, <code>admin</code> отключить | удалить</li>
<li>Отключить лишние сервисы и поменять стандартные порты</li>
<li>Настроить Firewall</li>
<li>Отключить mac-telnet, neighbors</li>
<li>Настроить Firewall IPv6 если нужно, иначе просто отключить IPv6</li>
<li>Опционально: <em>Port Knocking</em></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="vpn">VPN<a href="https://akmalov.com/blog/mikrotik-chr#vpn" class="hash-link" aria-label="Прямая ссылка на VPN" title="Прямая ссылка на VPN">​</a></h3>
<p>Этот облачный роутер настрою как центральный хаб, через который будет осуществляться подключение к домашней сети с различных устройств и внешний доступ к моим сервисам по https</p>
<p>Для подключения будет использоваться связка IPSec/L2TP. Настройки подробно описывать не буду, есть уже много готовых инструкций.</p>
<p>Когда <strong>Reverse Proxy Server</strong> находится в домашней сети, предстоит повозиться с машрутами т.к. по умолчанию обратные машруты <strong>nginx</strong> попытаются пойти через домашний маршрут в интернет</p>
<p><a href="https://akmalov.com/assets/files/chr.excalidraw-1c393ce95540131e6f6e341acce7774d.png" target="_blank"><img decoding="async" loading="lazy" alt="chr" src="https://akmalov.com/assets/images/chr.excalidraw-1c393ce95540131e6f6e341acce7774d.png" width="1760" height="860" class="img_ev3q"></a></p>
<p>Добавляю дополнительную таблицу маршрутизации <code>chr</code> на домашнем роутере</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/ip route</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> dst-address</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0.0</span><span class="token plain">.0.0/0 </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">gateway</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">l2tp routing-table</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">chr</span><br></span></code></pre></div></div>
<p>маркировка коннектов и трафика</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">action</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">mark-connection </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">chain</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prerouting in-interface</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">l2tp new-connection-mark</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">chr-conn </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">passthrough</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">yes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">action</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">mark-routing </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">chain</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">prerouting connection-mark</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">chr-conn new-routing-mark</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">chr-route </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">passthrough</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">yes</span><br></span></code></pre></div></div>
<ul>
<li>Если трафик пришел через l2tp туннель, помечаем соединение его как <code>chr-conn</code></li>
<li>Если видим помеченное соединение <code>chr-conn</code>, то добавляем маркировку трафика <code>chr-route</code></li>
</ul>
<p>Добавляю правило для <code>chr-route</code>, поменять таблицу маршрутизации на <code>chr</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/routing rule</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">add action=lookup-only-in-table disabled=no routing-mark=chr-route table=chr</span><br></span></code></pre></div></div>
<p>Как вариант можно поднять <strong>Reverse Proxy</strong> <a href="https://akmalov.com/blog/mikrotik-nginx" target="_blank" rel="noopener noreferrer">Nginx на самом Mikrotik CHR </a>. Ресурсы на VPS позволяют это спокойно сделать.</p>
<p>Данный способ выглядит еще интереснее и не нужно будет с маршрутами возится.</p>
<p>В целом все.</p>
<p>Пытался показать для чего я использую RouterOS CHR и как просто развернуть его в облаке.</p>]]></content:encoded>
            <category>homelab</category>
            <category>networks</category>
        </item>
        <item>
            <title><![CDATA[Mikrotik nginx reverse proxy]]></title>
            <link>https://akmalov.com/blog/mikrotik-nginx</link>
            <guid>https://akmalov.com/blog/mikrotik-nginx</guid>
            <pubDate>Wed, 29 Nov 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Mikrotik container nginx reverse proxy RouterOS container]]></description>
            <content:encoded><![CDATA[<p>Mikrotik запустить NGINX Reverse Proxy как контейнер в роутере</p>
<p><a href="https://akmalov.com/blog/mikrotik-nginx"><img decoding="async" loading="lazy" alt="mikrotik nginx container" src="https://akmalov.com/assets/images/logo-469e9f6a2bf984c4ebe66a38708cc51f.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="введение">Введение<a href="https://akmalov.com/blog/mikrotik-nginx#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5" class="hash-link" aria-label="Прямая ссылка на Введение" title="Прямая ссылка на Введение">​</a></h2>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="о-контейнерах-в-router-os">О контейнерах в Router OS<a href="https://akmalov.com/blog/mikrotik-nginx#%D0%BE-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%B0%D1%85-%D0%B2-router-os" class="hash-link" aria-label="Прямая ссылка на О контейнерах в Router OS" title="Прямая ссылка на О контейнерах в Router OS">​</a></h2>
<p>Начиная с RouterOS v7.4 и выше, в mikrotik подвезли такую штуку как <strong>Container</strong>, работает на устройствах <strong>arm, arm64, x86</strong></p>
<p>Страница с описанием и примерами настроек на wiki <a href="https://help.mikrotik.com/docs/display/ROS/Container" target="_blank" rel="noopener noreferrer">help.mikrotik.com</a></p>
<p>Мне очень нравятся контейнеры, люблю Docker и с такой фичей возможности домашнего роутера теперь ограничиваются только фантазией и ресурсами</p>
<p>Про ресурсы, для тестов имеется устройство Mikrotik hap ax3 (C53UiG+5HPaxD2HPaxD) <a href="https://mikrotik.com/product/hap_ax3" target="_blank" rel="noopener noreferrer">спецификация</a>:</p>
<ul>
<li><strong>Architecture:</strong>	ARM 64bit</li>
<li><strong>CPU:</strong> IPQ-6010, 4 core, (864 - 1800) MHz</li>
<li><strong>Size of RAM:</strong> 1 GB</li>
<li><strong>Storage size:</strong>	128 MB</li>
</ul>
<p>В целом 1Gb (из них свободно примерно 650Mb) не так и много на сегодня, что же можно там поднять? На сайте wiki разработчики показывают примеры с</p>
<ul>
<li>PiHole (DNS Server с возможностями блокировки рекламы) мне больше нравится его аналог AdguardHome</li>
<li>freeradius server - не знаю, насколько актуален сегодня radius server</li>
<li>mosquitto MQTT - Message Queuing Telemetry Transport (MQTT) Protocol. Для интернета вещей</li>
<li>ThingsBoard MQTT/HTTP server - еще одна платформа для интернета вещей</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Совет с официального сайта</div><div class="admonitionContent_BuS1"><p>Внедрение функции контейнера в RouterOS позволило запускать серверы для выполнения всевозможных задач внутри маршрутизатора. Это особенно актуально для людей, которые хотят уменьшить количество устройств в своей сети.
Вместо того, чтобы запускать сервер на отдельном устройстве/машине, почему бы не запустить его внутри маршрутизатора?
<a href="https://akmalov.com/assets/files/farcry-b667744f56ae59422879505ce5abb81e.png" target="_blank"><img decoding="async" loading="lazy" alt="farcry" src="https://akmalov.com/assets/images/farcry-b667744f56ae59422879505ce5abb81e.png" width="1440" height="900" class="img_ev3q"></a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="routeros-nginx-reverse-proxy">RouterOS nginx reverse proxy<a href="https://akmalov.com/blog/mikrotik-nginx#routeros-nginx-reverse-proxy" class="hash-link" aria-label="Прямая ссылка на RouterOS nginx reverse proxy" title="Прямая ссылка на RouterOS nginx reverse proxy">​</a></h2>
<p>На данный момент в качестве прокси сервера стоит отдельная виртуальная машина, на котором пробовал различные инструменты (nginx, traefik, caddy)</p>
<p>Попробую перенести и запустить это внутри маршрутизатора, выбрал <strong>nginx</strong> т.к. по ресурсам RAM, он потребляем меньше всего</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка">Подготовка<a href="https://akmalov.com/blog/mikrotik-nginx#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Подготовка" title="Прямая ссылка на Подготовка">​</a></h3>
<p>Функция <strong>container</strong> по умолчанию отключена, нужен физический доступ к маршрутизатору для включения</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>Disclaimer</div><div class="admonitionContent_BuS1"><ul>
<li>Запуск образа контейнера на вашем маршрутизаторе может открыть брешь в системе безопасности</li>
<li>Если маршрутизатор взломан, контейнеры могут быть использованы для простой установки вредоносного программного обеспечения на ваш маршрутизатор и по сети</li>
</ul></div></div>
<p>Разработчики настаивают на использовании внешненго накопителя (usb, ssd), чтобы не насиловать файловую систему самого роутера. Установил туда небольшого размера флешку на 32Gb</p>
<p><a href="https://akmalov.com/assets/files/mikrotik-usb-af1bf381a7e61ad2f2f9e498edf730df.jpg" target="_blank"><img decoding="async" loading="lazy" alt="mikrotik-usb" src="https://akmalov.com/assets/images/mikrotik-usb-af1bf381a7e61ad2f2f9e498edf730df.jpg" width="1200" height="595" class="img_ev3q"></a></p>
<p>Имеется поддержка USB 3.0</p>
<p><a href="https://akmalov.com/assets/files/mikrotik-usb-disk-1fba13d2e18c6927ffc0e71ac9dc181d.png" target="_blank"><img decoding="async" loading="lazy" alt="mikrotik-usb-disk" src="https://akmalov.com/assets/images/mikrotik-usb-disk-1fba13d2e18c6927ffc0e71ac9dc181d.png" width="822" height="495" class="img_ev3q"></a></p>
<p><strong>RouterOS</strong></p>
<ol>
<li>
<p>Необходимо скачать <a href="https://mikrotik.com/download" target="_blank" rel="noopener noreferrer"><strong>Extra packages</strong> с официального сайта</a> выбрав нужную архитектуру
В архиве несколько разных расширений, пример названия - <code>container-7.xx.x-arm64.npk</code>. Установить и перезагрузить</p>
</li>
<li>
<p>В терминале выполнить команду для включения функции <strong>Container</strong></p>
</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/system/device-mode/update container=yes</span><br></span></code></pre></div></div>
<p>После этого в терминале напишет сообщение, что нужно подтвердить нажатием кнопки сброса или перезагрузкой по питанию</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="запуск-nginx-container">Запуск nginx container<a href="https://akmalov.com/blog/mikrotik-nginx#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-nginx-container" class="hash-link" aria-label="Прямая ссылка на Запуск nginx container" title="Прямая ссылка на Запуск nginx container">​</a></h3>
<p>Добавить виртуальный интерфейс</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/interface/veth/add name=veth1 address=172.17.0.2/24 gateway=172.17.0.1</span><br></span></code></pre></div></div>
<p>Если нужно настроить для этого адреса NAT, добавить в bridge, проверить правила firewall</p>
<p>Настройка конфигурации <strong>container</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/config/set ram-high=200 registry-url=https://registry-1.docker.io tmpdir=usb1/tm</span><br></span></code></pre></div></div>
<p><a href="https://akmalov.com/assets/files/routeros-container-config-747ff0a5a704aaefa0af37142ac4b1e9.png" target="_blank"><img decoding="async" loading="lazy" alt="routeros-container-config" src="https://akmalov.com/assets/images/routeros-container-config-747ff0a5a704aaefa0af37142ac4b1e9.png" width="1067" height="452" class="img_ev3q"></a></p>
<p><strong>RAM Hight</strong> - Ограничение использования оперативной памяти (по умолчанию без лимита, рекомендую указать)</p>
<p><strong>Mount Points</strong></p>
<p>Точки монтирования зависят от конфигурации которую планируется использовать.</p>
<blockquote>
<p>Свою конфигурацию NGINX <a href="https://github.com/akmalovaa/mikrotik-nginx" target="_blank" rel="noopener noreferrer">прикладываю на Github</a></p>
</blockquote>
<p>Структура каталогов:
<a href="https://akmalov.com/assets/files/nginx-dir-8acbf5e9de979fdf4db9d800355f6cd6.png" target="_blank"><img decoding="async" loading="lazy" alt="nginx-dir" src="https://akmalov.com/assets/images/nginx-dir-8acbf5e9de979fdf4db9d800355f6cd6.png" width="900" height="500" class="img_ev3q"></a></p>
<p>В моей конфигурации для упрощения все хосты находятся в отдельных файлах
<code>config/proxy_host/*.conf</code>. Удобно при добавлении/удалении новых хостов - просто скопировать файл и изменить адрес, порт, домен (для отключения просто удалить файл). Остальные файлы конфигурации при этом можно вообще не трогать.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/mounts/add dst=/etc/nginx/nginx.conf name=nginx_conf src=/usb1/nginx/nginx.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/mounts/add dst=/etc/nginx/certs name=certs src=/usb1/nginx/certs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/mounts/add dst=/data name=nginx_data src=/usb1/nginx/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/mounts/add dst=/etc/nginx/conf.d name=nginx_confd src=/usb1/nginx/config</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Работа с файлами</div><div class="admonitionContent_BuS1"><p>Для удобства конфигурации и работы с файлами можно включить <strong>IP -&gt; SMB</strong> и расшарить USB по сети</p></div></div>
<p>Буду использовать <a href="https://hub.docker.com/_/nginx" target="_blank" rel="noopener noreferrer">nginx alpine с docker hub</a>
На сегодня последняя версия это <code>nginx:1.25.3-alpine</code></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/container/add remote-image=nginx:1.25.3-alpine interface=veth1 root-dir=usb1/docker/nginx mounts=nginx_conf,nginx_confd,nginx_data,certs</span><br></span></code></pre></div></div>
<p>Указать образ, виртуальный интерфейс, монтируемые директории,
<a href="https://akmalov.com/assets/files/mikrotik-container-4ff6aa0fa5e118009e7da0ea7f954d95.png" target="_blank"><img decoding="async" loading="lazy" alt="mikrotik-container" src="https://akmalov.com/assets/images/mikrotik-container-4ff6aa0fa5e118009e7da0ea7f954d95.png" width="977" height="647" class="img_ev3q"></a></p>
<p>Дополнительные возможности:</p>
<ul>
<li>передать ENV переменные</li>
<li>запускать контейнер при включении роутера</li>
<li>переопределять CMD и Entrypoint</li>
<li>и т.д.</li>
</ul>
<p><strong>root-dir</strong> - используется как изолированная файловая система для контейнера (в docker <strong>var/lib/docker/volume</strong>)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="итоги">Итоги<a href="https://akmalov.com/blog/mikrotik-nginx#%D0%B8%D1%82%D0%BE%D0%B3%D0%B8" class="hash-link" aria-label="Прямая ссылка на Итоги" title="Прямая ссылка на Итоги">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nginx-container">nginx container<a href="https://akmalov.com/blog/mikrotik-nginx#nginx-container" class="hash-link" aria-label="Прямая ссылка на nginx container" title="Прямая ссылка на nginx container">​</a></h3>
<p>NGINX запущен и работает, конфигурацию менять не очень удобно, как вариант можно использовать <strong>Nginx Proxy Manager</strong></p>
<p><strong>Nginx Proxy Manager</strong> - opensource проект, где в одном контейнере web-gui, db, nginx, certbot (и даже API для конфигурации)</p>
<ul>
<li><a href="https://github.com/NginxProxyManager/nginx-proxy-manager" target="_blank" rel="noopener noreferrer">Github проекта</a></li>
<li><a href="https://akmalov.com/blog/nginx-proxy-manager" target="_blank" rel="noopener noreferrer">Статья</a></li>
</ul>
<p>но, он использует гораздо больше <strong>RAM</strong> если на 1Gb запускать только его - думаю потянет.</p>
<p>Есть мысли как даже с минимальным nginx сделать удобнее изменение конфигурации, но пока ничего не сделано</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="container-stats">container stats<a href="https://akmalov.com/blog/mikrotik-nginx#container-stats" class="hash-link" aria-label="Прямая ссылка на container stats" title="Прямая ссылка на container stats">​</a></h3>
<p>На данный момент нет возможности удобно смотреть в mikrotik сколько ресурсов использует тот или иной контейнер, не очень удобно</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="что-еще-позапускать">что еще позапускать<a href="https://akmalov.com/blog/mikrotik-nginx#%D1%87%D1%82%D0%BE-%D0%B5%D1%89%D0%B5-%D0%BF%D0%BE%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0%D1%82%D1%8C" class="hash-link" aria-label="Прямая ссылка на что еще позапускать" title="Прямая ссылка на что еще позапускать">​</a></h3>
<ul>
<li>AdguardHome - можно, не особо требователен к ресурсам</li>
<li>Home Assistant - не хватит ресурсов</li>
<li>Альетрнативные reverse proxy - аналоги treafik, caddy</li>
<li>Python, bash, go - различные скрипты для расширения функциональности роутера</li>
<li>Prometheus exporter - было бы удобнее мониторить</li>
<li>Статичные сайты - без проблем</li>
<li>NextCloud, DB, S3, хранение файлов - попахивает извращением</li>
<li>Speedtest - различные контейнеры которые позволяют проверять канал, скорость USB + RAM наверное подставят</li>
</ul>
<p>Другие предложения, для чего еще можно использовать контейнеры в роутере микротик напижите пожалуйста в комментариях</p>]]></content:encoded>
            <category>homelab</category>
            <category>linux</category>
            <category>networks</category>
        </item>
        <item>
            <title><![CDATA[Uptime-kuma self-hosted monitoring]]></title>
            <link>https://akmalov.com/blog/uptime-kuma</link>
            <guid>https://akmalov.com/blog/uptime-kuma</guid>
            <pubDate>Mon, 06 Nov 2023 10:00:00 GMT</pubDate>
            <description><![CDATA[Простой и удобный способ мониторить хосты]]></description>
            <content:encoded><![CDATA[<p>Внешний сервис для мониторинга доступности хостов</p>
<p><a href="https://akmalov.com/blog/uptime-kuma"><img decoding="async" loading="lazy" alt="uptime-kuma" src="https://akmalov.com/assets/images/uptime-kuma-logo-cc272605e170ba93a58faa0939fdc358.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="внешний-мониторинг-хостов">Внешний мониторинг хостов<a href="https://akmalov.com/blog/uptime-kuma#%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3-%D1%85%D0%BE%D1%81%D1%82%D0%BE%D0%B2" class="hash-link" aria-label="Прямая ссылка на Внешний мониторинг хостов" title="Прямая ссылка на Внешний мониторинг хостов">​</a></h2>
<p>Для того чтобы проверять доступность своих сервисов снаружи (с интернета), необходим внешний инструмент мониторинга.
Это один из сервисов, которые приходится поднимать снаружи, не на своей инфраструктуре, т.к. внутренний мониторинг в этом деле не особо подходит, даже когда внутри все сервисы выглядят живыми, снаружи может не быть доступа по разным причинам.</p>
<p>Пробовал использовать разные варианты но самым простым оказался <strong>uptime-kuma</strong> сервис, который предоставляет простой и удобный способ мониторинга хостов.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="о-проекте-uptime-kuma">О проекте uptime-kuma<a href="https://akmalov.com/blog/uptime-kuma#%D0%BE-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B5-uptime-kuma" class="hash-link" aria-label="Прямая ссылка на О проекте uptime-kuma" title="Прямая ссылка на О проекте uptime-kuma">​</a></h2>
<p>Ссылка на <a href="https://github.com/louislam/uptime-kuma" target="_blank" rel="noopener noreferrer">Github</a></p>
<p>Основные плюсы:</p>
<ul>
<li>Большой выбор инструментов (способов) мониторинга HTTP, TCP, json, ping, DNS, Push, Steam сервисы, Docker контейнеры</li>
<li>Простой интуитивно понятный web интерфейс</li>
<li>Уведомления через Telegram, Discord, Gotify, Slack, Pushover, электронную почту (SMTP) и т.д.</li>
<li>Мультиязычный</li>
<li>Возможность создания отдельных страниц для предоставления общего доступа к статусам</li>
<li>Вывод результатов в графике</li>
<li>Информация о сертификатах SSL и сроках действия</li>
<li>Поддержка прокси-сервера</li>
<li>Поддержка 2FA (двухфакторной аутентификации)</li>
<li>Open-source</li>
</ul>
<p><a href="https://akmalov.com/assets/files/orig-f395a546e1b559d5a5008b8ec38b22e5.png" target="_blank"><img decoding="async" loading="lazy" alt="uptime-kuma" src="https://akmalov.com/assets/images/orig-f395a546e1b559d5a5008b8ec38b22e5.png" width="1024" height="641" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="установка">Установка<a href="https://akmalov.com/blog/uptime-kuma#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Установка" title="Прямая ссылка на Установка">​</a></h2>
<p>Планирую использовать облачный север от timeweb, можно взять сервер в РФ или заграницей</p>
<p><a href="https://akmalov.com/assets/files/timweb-server-254758ec7b3638d4bf1079e2bfbcfccd.png" target="_blank"><img decoding="async" loading="lazy" alt="uptime-kuma-server" src="https://akmalov.com/assets/images/timweb-server-254758ec7b3638d4bf1079e2bfbcfccd.png" width="1234" height="576" class="img_ev3q"></a></p>
<p>Подойдут минимальные характеристики, для удобства планирую использовать еще и доменное имя - <code>monitoring.example.com</code></p>
<ul>
<li><strong>OS</strong>: Ubuntu 22.02</li>
<li><strong>CPU</strong>: 1 x 2.8 ГГц</li>
<li><strong>RAM</strong>: 1 Gb</li>
<li><strong>SSD</strong>: 15 Gb</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-подготовка">1. Подготовка<a href="https://akmalov.com/blog/uptime-kuma#1-%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на 1. Подготовка" title="Прямая ссылка на 1. Подготовка">​</a></h3>
<p>Обновление пакетов и установка docker</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y curl</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">curl -fsSL https://get.docker.com -o get-docker.sh &amp;&amp; sudo sh get-docker.sh</span><br></span></code></pre></div></div>
<p>Конфигурация DNS перенаправление <code>monitoring.example.com</code> - на полученный белый IP от timeweb</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-настройка-docker-composeyaml">2. Настройка docker-compose.yaml<a href="https://akmalov.com/blog/uptime-kuma#2-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-docker-composeyaml" class="hash-link" aria-label="Прямая ссылка на 2. Настройка docker-compose.yaml" title="Прямая ссылка на 2. Настройка docker-compose.yaml">​</a></h3>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'3.8'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">caddy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> caddy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">2.7.5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token datetime number" style="color:rgb(247, 140, 108)">80:80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> 443</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./Caddyfile</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/etc/caddy/Caddyfile</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">uptime-kuma</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> louislam/uptime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">kuma</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">1.23.3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">debian</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./uptime</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">kuma</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/app/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> always</span><br></span></code></pre></div></div>
<p>Для автоматического получения SSL сертификата использую Caddy и создаю файл конфигурации <strong>Caddyfile</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">touch</span><span class="token plain"> Caddyfile</span><br></span></code></pre></div></div>
<p>Содержимое <strong>Caddyfile</strong>:</p>
<div class="language-JSON language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">monitoring.example.com </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    reverse_proxy uptime-kuma</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<p>Запуск контейнера</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker compose up -d</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="запуск-и-настройка">Запуск и настройка<a href="https://akmalov.com/blog/uptime-kuma#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D0%B8-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Запуск и настройка" title="Прямая ссылка на Запуск и настройка">​</a></h2>
<p>После запуска контейнера, можно подключиться к веб панели по домену <strong>monitoring.example.com</strong>.</p>
<p>Proxy сервис Caddy сам сходит получит сертификат и будет перенаправлять на HTTPS</p>
<p>При первом подключении, нужно создать пользователя и придумать пароль</p>
<p>В настройках:</p>
<ul>
<li>Проверить временную зону</li>
<li>Переключить на темную тему</li>
<li>Сменить язык на удобный</li>
<li>Добавить настройки для Telegram уведомлений</li>
</ul>
<p>Далее можно уже добавить первый монитор</p>
<p><a href="https://akmalov.com/assets/files/main-site-15cb66bcb13deb8e976b6db0ce1d649e.png" target="_blank"><img decoding="async" loading="lazy" alt="uptime-kuma-server" src="https://akmalov.com/assets/images/main-site-15cb66bcb13deb8e976b6db0ce1d649e.png" width="1872" height="940" class="img_ev3q"></a></p>
<p>По всем настройкам интерфейса, делать скрины и подробно расписывать не вижу смысла, все и так интуитивно понятно, а если вдруг хочется посмотреть и потыкаться, то на офф странице есть <a href="https://uptime.kuma.pet/" target="_blank" rel="noopener noreferrer">демо</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="итоги">Итоги<a href="https://akmalov.com/blog/uptime-kuma#%D0%B8%D1%82%D0%BE%D0%B3%D0%B8" class="hash-link" aria-label="Прямая ссылка на Итоги" title="Прямая ссылка на Итоги">​</a></h2>
<p>Мне очень понравился этот сервис, из того, что точно буду использовать:</p>
<ul>
<li>GET запрос для проверки сайта</li>
<li>ping серверов</li>
<li>проверка ответов API сервисов</li>
<li>оповещения в telegram</li>
<li>мониторинг срока действия ssl сертификатов</li>
</ul>
<p>Использование ресурсов (поднятый docker + 10 точек мониторинга занимают 140Mb RAM и минимальное CPU)</p>
<p>Из необычного, что впечатлило:</p>
<ul>
<li>Есть реверс проверка статуса (когда наоборот, если монитор стал доступен, то как ошибку воспринимать)</li>
<li>Push мониторинг - когда конечный сервис например за Proxy, NAT и нет к нему прямого доступа, можно с этого сервера Push отправлять на север uptime-kuma, которые он будет получать и мониторить</li>
<li>Специфичные средства мониторинга (Steam игровой сервер, PostgreSQL, Redis, Kafka, MongoDB и т.д.)</li>
<li>Можно создать дополнительную страницу, где вывести необходимые мониторы и поделиться ссылкой для просмотра (без аутентификации)</li>
</ul>
<p>Из минусов это единственная точка(узел) мониторинга и если будут проблемы на стороне облачного провайдера, то внешний мониторинг встанет, так же мониторинг с единственного узла не всегда показывает полную картину (например с других стран могут быть проблемы, о которых не получится оперативно узнать)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="бонус">Бонус<a href="https://akmalov.com/blog/uptime-kuma#%D0%B1%D0%BE%D0%BD%D1%83%D1%81" class="hash-link" aria-label="Прямая ссылка на Бонус" title="Прямая ссылка на Бонус">​</a></h3>
<p>Для минуса который описал выше, есть небольшое бесплатное решение, это мониторинг Selectel</p>
<p><a href="https://akmalov.com/assets/files/selectel-43891573f3dc3d8e4cdc8380a38ed54f.png" target="_blank"><img decoding="async" loading="lazy" alt="selectel мониторинг" src="https://akmalov.com/assets/images/selectel-43891573f3dc3d8e4cdc8380a38ed54f.png" width="1580" height="464" class="img_ev3q"></a></p>
<p>Если войти с панель управления под своим аккаунтом, можно бесплатно поставить в мониторинг до 3 метрик</p>
<p>Здесь так же имеются различные типы метрик, гибкие настройки, но самое главное 8 раличных точек мониторинга
<a href="https://akmalov.com/assets/files/selectel_get-011d52d7f400f7dafb38bd2c03311f61.png" target="_blank"><img decoding="async" loading="lazy" alt="selectel мониторинг" src="https://akmalov.com/assets/images/selectel_get-011d52d7f400f7dafb38bd2c03311f61.png" width="1118" height="572" class="img_ev3q"></a></p>
<ul>
<li>Франкфурт</li>
<li>Лондон</li>
<li>Амстердам</li>
<li>Москва</li>
<li>Новосибирск</li>
<li>Санкт-Петербург</li>
<li>Нью-Йорк</li>
<li>Сан-Франциско</li>
</ul>
<p>Возможно, кому хватит такого количества метрик и нет желания поднимать и настраивать облачный сервер, данный вариант покажется даже удобнее.</p>]]></content:encoded>
            <category>monitoring</category>
            <category>docker</category>
            <category>ssl</category>
        </item>
        <item>
            <title><![CDATA[Auto wildcard cert service]]></title>
            <link>https://akmalov.com/blog/wildcard-ssl-cert</link>
            <guid>https://akmalov.com/blog/wildcard-ssl-cert</guid>
            <pubDate>Sat, 23 Sep 2023 10:00:00 GMT</pubDate>
            <description><![CDATA[Простой способ получить wildcard ssl сертификат для своего домена с использованием Cloudflare и acme.sh]]></description>
            <content:encoded><![CDATA[<p>Простой способ получить wildcard SSL сертификат для своего домена с использованием Cloudflare и acme.sh</p>
<p><a href="https://akmalov.com/blog/wildcard-ssl-cert"><img decoding="async" loading="lazy" alt="wildcard ssl cert" src="https://akmalov.com/assets/images/wildcard-logo-b96826c9a1c679c2e1aa0962a1f3f713.png" width="1498" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wildcard-сертификат">Wildcard сертификат<a href="https://akmalov.com/blog/wildcard-ssl-cert#wildcard-%D1%81%D0%B5%D1%80%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%82" class="hash-link" aria-label="Прямая ссылка на Wildcard сертификат" title="Прямая ссылка на Wildcard сертификат">​</a></h2>
<p>Нравится изучать различные OpenSource проекты, и сейчас для многих сервисов которые запускаю у себя на серверах требуются доверенные сертификаты SSL</p>
<p>Имеется свой собственный домен <code>akmalov.com</code> и поддмены следующего уровня <code>*.akmalov.com</code> создавать в любом количестве и не проблема</p>
<p>Раньше пробовал использовать свой центр сертификации, прописывал в доверенных, создавал сампоподисанные сертификаты (очень неудобно, слишком много ресурсов для песочницы).
Далее решил перейти на скрипты и для отдельных поддоменов заказывал сертификаты с помощью <strong>Let's Encrypt</strong> и когда поддоменов набралось больше десятка решил попробовать <strong>wildcard</strong> сертификат, который может быть применен для всех поддоменов.</p>
<blockquote>
<p>Один сертификат для всех поддоменов</p>
</blockquote>
<p><a href="https://akmalov.com/assets/files/wildcard-baf20bbce2641b2b9185a38df454ec3f.jpg" target="_blank"><img decoding="async" loading="lazy" alt="wildcard" src="https://akmalov.com/assets/images/wildcard-baf20bbce2641b2b9185a38df454ec3f.jpg" width="942" height="408" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="acme-shell-script">ACME Shell script<a href="https://akmalov.com/blog/wildcard-ssl-cert#acme-shell-script" class="hash-link" aria-label="Прямая ссылка на ACME Shell script" title="Прямая ссылка на ACME Shell script">​</a></h2>
<p>После того как перепробовал различные варианты получения сертификатов, для меня самым удобным показался <strong>acme.sh</strong></p>
<p>Ссылка на офф <a href="https://github.com/acmesh-official/acme.sh" target="_blank" rel="noopener noreferrer">Github</a></p>
<ul>
<li>Unix shell скрипт без лишних зависимостей</li>
<li>Не нужны root права</li>
<li>Есть docker образ</li>
<li>Поддерживает IPv6</li>
<li>Можно использовать в cron-job для автоматического обновления сертификатов</li>
<li>Простые команды для управления</li>
<li>Умеет по API обращаться к Cloudflare</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cloudflare">Cloudflare<a href="https://akmalov.com/blog/wildcard-ssl-cert#cloudflare" class="hash-link" aria-label="Прямая ссылка на Cloudflare" title="Прямая ссылка на Cloudflare">​</a></h2>
<p>Для управлениями DNS записями домена использую Cloudflare, из за его популярности и возможности управления по API, для многих сервисов есть очень удобные интеграции. Одна из причин выбора acme.sh это как раз, то что он дружит Cloudflare.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>примечание</div><div class="admonitionContent_BuS1"><p>Если используется другой DNS провайдер, можно использовать ручной способ указанный в документации, где придется вручную создавать <code>TXT</code> записи в админке домена</p></div></div>
<p>Пошагово получение API токена в Cloudflare:</p>
<ul>
<li>Войти в свой аккаунт <a href="https://dash.cloudflare.com/" target="_blank" rel="noopener noreferrer">Cloudflare</a></li>
<li>Нажать на иконку профиля в верхней части экрана и выбрать <strong>My Profile</strong> в выпадающем меню.</li>
<li>Далее выберите <strong>API Tokens</strong> на левой панели меню.</li>
<li>Нажать на кнопку <strong>Create Token</strong> в верхней части страницы.</li>
<li>Выбрать тип токена, который нужен, задать параметры и уровень доступа для токена.</li>
<li>На странице созданного токена нужно скопировать  <strong>API Token</strong> и сохранить его (отображается только при создании больше его увидеть не получится, только пересоздать)</li>
</ul>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Осторожно</div><div class="admonitionContent_BuS1"><p>Токен нельзя светить где попало</p></div></div>
<p><a href="https://akmalov.com/assets/files/cloudflare-api-010f4fa6a891018ed0ab788080a40177.png" target="_blank"><img decoding="async" loading="lazy" alt="Cloudflare" src="https://akmalov.com/assets/images/cloudflare-api-010f4fa6a891018ed0ab788080a40177.png" width="1285" height="483" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="docker-acmesh">Docker acme.sh<a href="https://akmalov.com/blog/wildcard-ssl-cert#docker-acmesh" class="hash-link" aria-label="Прямая ссылка на Docker acme.sh" title="Прямая ссылка на Docker acme.sh">​</a></h2>
<p>Как один из больших поклонников контейнеров, не фанат устанавливать что-либо на хост систему, даже если это просто копирование скриптов.
Разработчики данного сервиса такого же мнения 💕</p>
<p>Страница на Github - <a href="https://github.com/acmesh-official/acme.sh/wiki/Run-acme.sh-in-docker" target="_blank" rel="noopener noreferrer"><strong>Run acme.sh in docker</strong></a></p>
<p>Официальный образ <a href="https://hub.docker.com/r/neilpang/acme.sh" target="_blank" rel="noopener noreferrer"><strong>Dockerhub</strong></a></p>
<p>Загрузить последнюю версию или tag <code>latest</code>, привык использовать конкретную версию:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> pull neilpang/acme.sh:3.0.6 </span><br></span></code></pre></div></div>
<p>Для удобства с переменными буду использовать <code>.env</code> файл, следующего содержания:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">EMAIL=artur@example.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">URL=example.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WILDCARD_URL=*.example.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CF_Token=Your cloudflare API TOKEN</span><br></span></code></pre></div></div>
<p>В начале необходимо выполнить команду регистрации ACME по <strong>email</strong>, которая будет использоваться для создания ключа.</p>
<p>Полученный в результате файл, нужен будет для запуска следующей команды и поэтому его необходимо сохранить вне контейнера.</p>
<p>Команда <code>-v "./acme_data":/acme.sh</code> позволит создать локально на хосте директорию в которую будут сохраняться полученные файлы и останутся даже когда контейнер отработает и закроется.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--rm</span><span class="token plain"> --env-file .env </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"./acme_data"</span><span class="token plain">:/acme.sh neilpang/acme.sh:3.0.6 --register-account </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-m</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$EMAIL</span><br></span></code></pre></div></div>
<p>В логах должно быть сообщение об успешной регистрации аккаунта</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Create account key ok.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Registered</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; ACCOUNT_THUMBPRINT='ACCOUNT KEY'</span><br></span></code></pre></div></div>
<p>Запрос <strong>wildcard</strong> сертификата</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--rm</span><span class="token plain"> --env-file .env </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-v</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"./acme_data"</span><span class="token plain">:/acme.sh neilpang/acme.sh:3.0.6 </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--issue</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-d</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$URL</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-d</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">$WILDCARD_URL</span><span class="token plain">  </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">--dns</span><span class="token plain"> dns_cf</span><br></span></code></pre></div></div>
<p>Процесс занимает примерно 3-7 минут</p>
<p>В логах по результатам запроса:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Multi domain='DNS:example.com,DNS:*.example.com'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Getting domain auth token for each domain</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Getting webroot for domain='example.com'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Getting webroot for domain='*.example.com'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Adding record</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Added, OK</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; The txt record is added: Success.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Let's check each DNS record now. Sleep 20 seconds first.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Checking example.com for _acme-challenge.example.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Domain example.com '_acme-challenge.example.com' success.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; All success, let's return</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Verifying: example.com</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Processing, The CA is processing your order, please just wait. (1/30)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Success</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Removing DNS records.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Removed: Success</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Downloading cert.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&gt; Cert success.</span><br></span></code></pre></div></div>
<p>Сертификат получен и готов для использования (срок 3 месяца), все файлы сохранены локально в директории <code>./acme_data</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ls</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-la</span><span class="token plain"> acme_data/example.com_ecc</span><br></span></code></pre></div></div>
<div class="language-output codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-output codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 1456 Sep 24 18:33 example.com.cer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  566 Sep 24 18:33 example.com.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  477 Sep 24 18:29 example.com.csr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r--  202 Sep 24 18:29 example.com.csr.conf</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-------  227 Sep 24 18:28 example.com.key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 2668 Sep 24 18:33 ca.cer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-rw-r--r-- 4124 Sep 24 18:33 fullchain.cer</span><br></span></code></pre></div></div>
<p>Можно проверить полученный сертификат командой:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">openssl x509 </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-in</span><span class="token plain"> acme_data/example.com_ecc/example.com.cer </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-text</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-noout</span><br></span></code></pre></div></div>
<p>или онлайн сервисом <a href="https://www.sslshopper.com/certificate-decoder.html" target="_blank" rel="noopener noreferrer">Certificate Decoder</a></p>
<p>Дальше тоже можно автоматизировать, создав расписание на выполнение и отправку результатов куда нужно.</p>]]></content:encoded>
            <category>docker</category>
            <category>homelab</category>
            <category>ssl</category>
        </item>
        <item>
            <title><![CDATA[Monitoring web hosts]]></title>
            <link>https://akmalov.com/blog/monitoring-web-hosts</link>
            <guid>https://akmalov.com/blog/monitoring-web-hosts</guid>
            <pubDate>Thu, 13 Jul 2023 10:42:00 GMT</pubDate>
            <description><![CDATA[monitoring web ssl certificate expried uptime kuma grafana prometheus docker]]></description>
            <content:encoded><![CDATA[<p>self-hosted сервер мониторинга доступности хостов, времени действия SSL сертификатов с оповещениями в telegram</p>
<p><a href="https://akmalov.com/blog/monitoring-web-hosts"><img decoding="async" loading="lazy" alt="Monitoring web hosts" src="https://akmalov.com/assets/images/monitoring-web-hosts-logo-b1ba2ab5f07b6e69140fa7c31431038e.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="uptime-kuma">Uptime-kuma<a href="https://akmalov.com/blog/monitoring-web-hosts#uptime-kuma" class="hash-link" aria-label="Прямая ссылка на Uptime-kuma" title="Прямая ссылка на Uptime-kuma">​</a></h2>
<p>Если вам нужен самый простой и удобный инструмент мониторинга хостов, который можно поднять у себя на сервере проще воспользоваться сервисом <code>Uptime-Kuma</code></p>
<p><a href="https://github.com/louislam/uptime-kuma" target="_blank" rel="noopener noreferrer">Uptime-Kuma</a></p>
<p><img decoding="async" loading="lazy" alt="Uptime-Kuma" src="https://akmalov.com/assets/images/uptime-kuma-87329102b96002a5c3aa7e6720f8c9e7.jpg" width="1024" height="641" class="img_ev3q"></p>
<p>Главные фишки:</p>
<ul>
<li>Мониторинг HTTP(s) / TCP / HTTP(s) Keyword / HTTP(s) Json Query / Ping / DNS</li>
<li>Лекго и просто развернуть в docker-compose</li>
<li>Удобный и понятный графический интерфейс</li>
<li>Оповещения в Telegram, Discord, Slack, Email (SMTP) и т.д.</li>
<li>Информация о сертификате (SSL Certificate info)</li>
<li>Поддержка Proxy и 2FA</li>
</ul>
<p>При обнаружении проблем с доступностью, Uptime-Kuma быстро уведомляет пользователя различными способами, включая такие популярные платформы, как Telegram, Discord и Slack.</p>
<p>Аналитические функции, такие как графики и статистика, предоставляют полезные данные для понимания причин проблем с доступностью, помогая пользователям своевременно реагировать и улучшать свои сервисы.</p>
<p>В целом, Uptime-Kuma - это незаменимый инструмент для тех, кто хочет быть уверенным в непрерывной работе и доступности своих веб-сервисов.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="сервер-мониторинга">Сервер мониторинга<a href="https://akmalov.com/blog/monitoring-web-hosts#%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%D0%B0" class="hash-link" aria-label="Прямая ссылка на Сервер мониторинга" title="Прямая ссылка на Сервер мониторинга">​</a></h2>
<p>Если уже используется стэк для мониторинга Promeheus + Grafana можно воспользваться blackbox exporter и сделать удобный Dashboard для себя. Об этом сейчас и буду писать подробнее</p>
<p><strong>Простой пример мониторинга хостов и истечения срока действия SSL-сертификата</strong></p>
<p><a href="https://akmalov.com/assets/files/grafana-ssl-certificate-expires-694b82ef0991ebbc6730e8e1f0dae8d2.png" target="_blank"><img decoding="async" loading="lazy" alt="Grafana ssl certificate expires" src="https://akmalov.com/assets/images/grafana-ssl-certificate-expires-694b82ef0991ebbc6730e8e1f0dae8d2.png" width="1872" height="470" class="img_ev3q"></a></p>
<p>Используется следующие сервисы:</p>
<ul>
<li>Prometheus (сбор и база данных)</li>
<li>Grafana (отображение данных)</li>
<li>Blackbox (мониторинг http)</li>
<li>Alertmanager (уведомления)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="установка">Установка<a href="https://akmalov.com/blog/monitoring-web-hosts#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Установка" title="Прямая ссылка на Установка">​</a></h3>
<p>Сам проект на <a href="https://github.com/akmalovaa/monitoring-hosts-cert/tree/main" target="_blank" rel="noopener noreferrer">Github monitoring hosts</a></p>
<p>используется docker-compose 🐳</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/akmalovaa/monitoring-hosts-cert.git</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> monitoring-hosts-cert</span><br></span></code></pre></div></div>
<ul>
<li>
<p>Изменить конечные хосты <code>/prometheus/prometheus.yml</code></p>
</li>
<li>
<p>Настройка для отправки сообщений в телеграм <code>/alertmanager/config.yml</code></p>
</li>
<li>
<p>Добавить права на директорию для графаны:</p>
</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">chmod</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-R</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">777</span><span class="token plain"> data/grafana/</span><br></span></code></pre></div></div>
<p>Запустить сервисы</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker-compose</span><span class="token plain"> up </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-d</span><br></span></code></pre></div></div>
<p>Проверить сервисы</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker-compose</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">ps</span><br></span></code></pre></div></div>
<p>Telegram уведомления:
<img decoding="async" loading="lazy" alt="telegram alertmanager" src="https://akmalov.com/assets/images/telegram-alertmanager-1f0e17b64f4d7e7240786c611a44877d.png" width="805" height="378" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="дополнительные-материалы">Дополнительные материалы<a href="https://akmalov.com/blog/monitoring-web-hosts#%D0%B4%D0%BE%D0%BF%D0%BE%D0%BB%D0%BD%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%BC%D0%B0%D1%82%D0%B5%D1%80%D0%B8%D0%B0%D0%BB%D1%8B" class="hash-link" aria-label="Прямая ссылка на Дополнительные материалы" title="Прямая ссылка на Дополнительные материалы">​</a></h3>
<ul>
<li>
<p>Grafana labs - <a href="https://grafana.com/grafana/dashboards/13230-certificate-monitor/" target="_blank" rel="noopener noreferrer">Dashboard</a></p>
</li>
<li>
<p>Grafana blog - <a href="https://grafana.com/blog/2020/11/25/how-we-eliminated-service-outages-from-certificate-expired-by-setting-up-alerts-with-grafana-and-prometheus/" target="_blank" rel="noopener noreferrer">Post SSL alerting</a></p>
</li>
<li>
<p>Github Prometheus, Grafana, blackbox, alertmanager + caddy - <a href="https://github.com/stefanprodan/dockprom/tree/master" target="_blank" rel="noopener noreferrer">docker-compose example</a></p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="настройки-alertmanager-telegram">Настройки Alertmanager telegram<a href="https://akmalov.com/blog/monitoring-web-hosts#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8-alertmanager-telegram" class="hash-link" aria-label="Прямая ссылка на Настройки Alertmanager telegram" title="Прямая ссылка на Настройки Alertmanager telegram">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="bot-token">Bot token<a href="https://akmalov.com/blog/monitoring-web-hosts#bot-token" class="hash-link" aria-label="Прямая ссылка на Bot token" title="Прямая ссылка на Bot token">​</a></h5>
<p>Создайте бота и получите ключ API бота в канале <a href="https://t.me/BotFather" target="_blank" rel="noopener noreferrer">BotFather</a></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="получить-chat-id-telegram">Получить Chat ID telegram<a href="https://akmalov.com/blog/monitoring-web-hosts#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C-chat-id-telegram" class="hash-link" aria-label="Прямая ссылка на Получить Chat ID telegram" title="Прямая ссылка на Получить Chat ID telegram">​</a></h5>
<p>Напишите пару тестовых сообщений созданному только что боту, затем выполните запрос</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> https://api.telegram.org/bot</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">TOKEN</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">/getUpdates </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> jq</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="docker-compose">docker-compose<a href="https://akmalov.com/blog/monitoring-web-hosts#docker-compose" class="hash-link" aria-label="Прямая ссылка на docker-compose" title="Прямая ссылка на docker-compose">​</a></h4>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">version: "3.7"</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">services:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  prometheus:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: prometheus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: prom/prometheus:v2.46.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--config.file=/etc/prometheus/prometheus.yml'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--storage.tsdb.path=/prometheus'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--web.console.libraries=/etc/prometheus/console_libraries'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--web.console.templates=/etc/prometheus/consoles'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--storage.tsdb.retention.time=30d'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--web.enable-lifecycle'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    user: root</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - 9090:9090</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - ./prometheus:/etc/prometheus/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - ./data/prometheus:/prometheus/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: unless-stopped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     - TZ="Asia/Yekaterinburg"</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  blackbox:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: blackbox</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: prom/blackbox-exporter:v0.24.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--config.file=/config/blackbox.yml'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - 9115:9115</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: unless-stopped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - ./blackbox:/config</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  alertmanager:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: alertmanager</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: prom/alertmanager:v0.25.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--config.file=/etc/alertmanager/config.yml'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - '--storage.path=/alertmanager'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - 9093:9093</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - ./alertmanager:/etc/alertmanager/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: unless-stopped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  grafana:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    container_name: grafana</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    image: grafana/grafana:10.0.3-ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    depends_on:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - prometheus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - 3000:3000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - ./data/grafana:/var/lib/grafana</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - ./grafana/datasources:/etc/grafana/provisioning/datasources</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    restart: unless-stopped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - GF_SECURITY_ADMIN_USER=${ADMIN_USER:-admin}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - GF_SECURITY_ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - GF_USERS_ALLOW_SIGN_UP=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - TZ="Asia/Yekaterinburg"</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>monitoring</category>
            <category>ssl</category>
            <category>docker</category>
        </item>
        <item>
            <title><![CDATA[Docusaurus комментарии]]></title>
            <link>https://akmalov.com/blog/docusaurus-comments</link>
            <guid>https://akmalov.com/blog/docusaurus-comments</guid>
            <pubDate>Sat, 17 Jun 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Add commenst docusaurus, добавление коментариев в docusaurus с использованием Giscus]]></description>
            <content:encoded><![CDATA[<p>Добавить комментарии, обсуждения в записях блога docusaurus</p>
<p><a href="https://akmalov.com/blog/docusaurus-comments"><img decoding="async" loading="lazy" alt="docusaurus comments" src="https://akmalov.com/assets/images/docusaurus-comments-434e8902a13264175b7df3a8acce9235.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="комментарии-и-обсуждения-для-блога">Комментарии и обсуждения для блога<a href="https://akmalov.com/blog/docusaurus-comments#%D0%BA%D0%BE%D0%BC%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%80%D0%B8%D0%B8-%D0%B8-%D0%BE%D0%B1%D1%81%D1%83%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%B1%D0%BB%D0%BE%D0%B3%D0%B0" class="hash-link" aria-label="Прямая ссылка на Комментарии и обсуждения для блога" title="Прямая ссылка на Комментарии и обсуждения для блога">​</a></h2>
<p>На мой взгляд это очень полезная штука.</p>
<ul>
<li>Комментарии дают возможность высказаться и поделиться своим мнением, задать вопросы или дополнить тему статьи.</li>
<li>Для обсуждения идей и обмена знаниями, могут стимулировать дискуссии и помочь узнать что-то новое.</li>
</ul>
<p>Искал разные решения и в итоге остановился на <strong>Giscus</strong></p>
<p>Это opensource проект для добавления обсуждений через Discussions Github</p>
<p>Офф.сайт - <a href="https://giscus.app/ru" target="_blank" rel="noopener noreferrer">https://giscus.app/ru</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="настройка-github">Настройка Github<a href="https://akmalov.com/blog/docusaurus-comments#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-github" class="hash-link" aria-label="Прямая ссылка на Настройка Github" title="Прямая ссылка на Настройка Github">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="включить-обсуждения">Включить обсуждения<a href="https://akmalov.com/blog/docusaurus-comments#%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D1%8C-%D0%BE%D0%B1%D1%81%D1%83%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F" class="hash-link" aria-label="Прямая ссылка на Включить обсуждения" title="Прямая ссылка на Включить обсуждения">​</a></h3>
<p>Нужно активировать Discussion в настройках репозитория</p>
<p><img decoding="async" loading="lazy" alt="Discussion" src="https://akmalov.com/assets/images/discussions-enable-c0cf29e5f6d209e9f709bfdef3f613fa.png" width="1053" height="260" class="img_ev3q"></p>
<p>После этого для удобства удалил лишние категории, оставил только Generals</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="установка-giscus-app">Установка Giscus App<a href="https://akmalov.com/blog/docusaurus-comments#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-giscus-app" class="hash-link" aria-label="Прямая ссылка на Установка Giscus App" title="Прямая ссылка на Установка Giscus App">​</a></h3>
<p>Установить для выбранного репозитория Giscus GitHub App</p>
<p><a href="https://github.com/apps/giscus" target="_blank" rel="noopener noreferrer">https://github.com/apps/giscus</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="настройка-giscus">Настройка Giscus<a href="https://akmalov.com/blog/docusaurus-comments#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-giscus" class="hash-link" aria-label="Прямая ссылка на Настройка Giscus" title="Прямая ссылка на Настройка Giscus">​</a></h2>
<p>Установка пакета</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">npm add @giscus/react</span><br></span></code></pre></div></div>
<p>Создание компонента</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">npm run swizzle @docusaurus/theme-classic BlogPostItem -- --wrap</span><br></span></code></pre></div></div>
<p>Дання команда создаст файл по пути <code>src/theme/BlogPostItem/index.js</code></p>
<p>Переименовать файл в <strong>BlogPostItem.tsx</strong> и положить уровнем выше в итоге получится <code>src/theme/BlogPostItem.tsx</code></p>
<p>Содержание файла</p>
<div class="language-tsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-tsx codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'react'</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">BlogPostItem</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'@theme-original/BlogPostItem'</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token imports"> useBlogPost </span><span class="token imports punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"@docusaurus/theme-common/internal"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">Giscus</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"@giscus/react"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">export</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">default</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">function</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">BlogPostItemWrapper</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"> isBlogPostPage </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">useBlogPost</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">isBlogPostPage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">BlogPostItem</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token tag spread" style="color:rgb(255, 85, 114)">props</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">BlogPostItem</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag spread operator" style="color:rgb(137, 221, 255)">...</span><span class="token tag spread" style="color:rgb(255, 85, 114)">props</span><span class="token tag spread punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain-text">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">className</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">docusaurus-blog-comments</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain-text">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag class-name" style="color:rgb(255, 203, 107)">Giscus</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">repo</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">akmalovaa/akmalov.com</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">repoId</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">R_kgDOI0gPCg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">category</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">General</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">categoryId</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">DIC_kwDOI0gPCs4CXR_A</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">mapping</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">pathname</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">reactionsEnabled</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">emitMetadata</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">inputPosition</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">bottom</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">theme</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">dark</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">lang</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token tag script language-javascript string" style="color:rgb(195, 232, 141)">'ru'</span><span class="token tag script language-javascript punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">            </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">loading</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">lazy</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">"</span><span class="token tag" style="color:rgb(255, 85, 114)"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">          </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">div</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>подсказка</div><div class="admonitionContent_BuS1"><p>Можно сделать лучше и кусок с Giscus перенести в <code>src/components</code> а переменные через dotenv файл потдягивать</p></div></div>
<p>Пока буду делать просто и топорно, т.к. github Discussion сейчас активно развивается и возможны изменения в API - необходимо будет быстро исправить.</p>
<p>Пройдемся по переменным:</p>
<ul>
<li><code>repo</code> тут все понятно автор и репо</li>
<li><code>repoId</code> нужно будет вытащить через API</li>
<li><code>category</code> название категории в Discussion</li>
<li><code>categoryId</code> нужно будет вытащить через API</li>
</ul>
<p>Удобнее всего ID вытаскивать через GraphQL запрос вытаскивать.
Если уже установлена Github CLI то можно выполнить команду:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">gh api graphql </span><span class="token parameter variable" style="color:rgb(191, 199, 213)">-f</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">query</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">'{ </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  repository(owner: "akmalovaa", name:"akmalov.com"){</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    discussionCategories(first:10) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      edges {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">        node {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">          id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">          name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">'</span><br></span></code></pre></div></div>
<p>Нужно подставить свои <strong>owner</strong> и repo <strong>name</strong>. В ответ придет json с ID репозитория и категорий.</p>
<p>Можно попробовать через Github API эти данные вытащить, но способ выше показался проще.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="итого">Итого<a href="https://akmalov.com/blog/docusaurus-comments#%D0%B8%D1%82%D0%BE%D0%B3%D0%BE" class="hash-link" aria-label="Прямая ссылка на Итого" title="Прямая ссылка на Итого">​</a></h2>
<p>Вроде без особых сложностей можно добавить комментарии в своем блоге с docusaurus.</p>
<p>Некоторые сервисы (аналоги giscus) используют для комментов <code>github issue</code>, но мне кажется <code>github discussions</code> лучше для этого подходит и по логике и по функционалу.</p>]]></content:encoded>
            <category>docusaurus</category>
            <category>github</category>
        </item>
        <item>
            <title><![CDATA[Gitlab auto add reviewers]]></title>
            <link>https://akmalov.com/blog/gitlab-auto-reviewers</link>
            <guid>https://akmalov.com/blog/gitlab-auto-reviewers</guid>
            <pubDate>Tue, 30 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Gitlab auto assign reviewer for merge request]]></description>
            <content:encoded><![CDATA[<p>Gitlab auto assign reviewer — Автоматическое подставление assignee и reviewers при создании mergre request</p>
<p><a href="https://akmalov.com/blog/gitlab-auto-reviewers"><img decoding="async" loading="lazy" alt="nginx logo" src="https://akmalov.com/assets/images/gitlab-reviewers-c3e4e494b3c1598ca2d3333cd210227a.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="gitlab-auto-add-reviewers">Gitlab auto add reviewers<a href="https://akmalov.com/blog/gitlab-auto-reviewers#gitlab-auto-add-reviewers" class="hash-link" aria-label="Прямая ссылка на Gitlab auto add reviewers" title="Прямая ссылка на Gitlab auto add reviewers">​</a></h2>
<p><strong>Цель</strong>: при создании Merge Request сделать удобное добавление ревьюверов</p>
<p><img decoding="async" loading="lazy" alt="mr reviewers" src="https://akmalov.com/assets/images/mr-f18b428bbad8907030149a86c8b83e1f.png" title="mr reviewers" width="1292" height="750" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-reviewer-templates">1. Reviewer templates<a href="https://akmalov.com/blog/gitlab-auto-reviewers#1-reviewer-templates" class="hash-link" aria-label="Прямая ссылка на 1. Reviewer templates" title="Прямая ссылка на 1. Reviewer templates">​</a></h2>
<p>Первый способ который поможет в добавлении ревьюверов - это использование templates. Встроенная фича Gitlab, бесплатная для всех версий.</p>
<p>Документация - <a href="https://docs.gitlab.com/ee/user/project/description_templates.html" target="_blank" rel="noopener noreferrer">Description templates</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка">Подготовка<a href="https://akmalov.com/blog/gitlab-auto-reviewers#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Подготовка" title="Прямая ссылка на Подготовка">​</a></h3>
<p>Нужно создать директорию <code>.gitlab/merge_request_templates</code></p>
<p>Создать внутри любой файл расширения <code>.md</code></p>
<p>Например <code>top_reviewers.md</code></p>
<p>С таким содержанием, где нужно добавить username ревьюверов:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/assign_reviewer @user1 @user2</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="gitlab template" src="https://akmalov.com/assets/images/gitlab-template-a81aa1e33546eba521e392c74d5b96c0.png" title="gitlab template" width="1283" height="328" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="использование">Использование<a href="https://akmalov.com/blog/gitlab-auto-reviewers#%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5" class="hash-link" aria-label="Прямая ссылка на Использование" title="Прямая ссылка на Использование">​</a></h3>
<p>После добавления такого template, при создании новых MR появится дополнительное поле, где можно выбрать созданные шаблоны</p>
<p><img decoding="async" loading="lazy" alt="gitlab template" src="https://akmalov.com/assets/images/gitlab-mr-template-44098fae936bf6b74d5cfb6958c9e6e1.png" title="gitlab template" width="1413" height="756" class="img_ev3q"></p>
<p>Удобный способ, особенно если несколько разных групп ревбюверов, можно создавать несколько частых шаблонов и использовать их.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-bash-gitlab-api">2. Bash gitlab API<a href="https://akmalov.com/blog/gitlab-auto-reviewers#2-bash-gitlab-api" class="hash-link" aria-label="Прямая ссылка на 2. Bash gitlab API" title="Прямая ссылка на 2. Bash gitlab API">​</a></h2>
<p>Данный способ - добавление скрипта в <code>.gitlab-ci.yml</code> CI/CD, который позволит через API автоматический добавлять ревьюверов</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка-1">Подготовка<a href="https://akmalov.com/blog/gitlab-auto-reviewers#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0-1" class="hash-link" aria-label="Прямая ссылка на Подготовка" title="Прямая ссылка на Подготовка">​</a></h3>
<p>Для отслеживания создания merge request можно использовать разные события(триггеры):</p>
<ul>
<li>Gitlab CI workflow event</li>
<li>Schedules</li>
<li>Прочие события</li>
</ul>
<p>Я буду использовать <code>workflow — merge request event</code>, для этого добавил в <strong>workflow</strong> триггер на создание MR:</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">workflow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $CI_PIPELINE_SOURCE == "merge_request_event"</span><br></span></code></pre></div></div>
<p>Переменные <strong>Settings -&gt; CI/CD -&gt; Variables</strong></p>
<ul>
<li><code>$TOKEN</code> - Gitlab API Token</li>
</ul>
<p>В gitlab runner где запускается pipeline нужен jq
Заранее установленый или доставить перед запуском скрипта:</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">before_script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> apt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">get install jq </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">y</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="скрипт">Скрипт<a href="https://akmalov.com/blog/gitlab-auto-reviewers#%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82" class="hash-link" aria-label="Прямая ссылка на Скрипт" title="Прямая ссылка на Скрипт">​</a></h3>
<p>Пошаговая логика скрипта:</p>
<ul>
<li>Получить последний merge request ID</li>
<li>Получить ID автора merge request</li>
<li>Назначить Assigne = ID Автора</li>
<li>Назначить Reviewers = из переменной  Reviewers(list)</li>
</ul>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">PROJECT_URL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/merge_requests'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">REVIEWERS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'10043654'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Reviewers Gitlab ID List</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">.gitlab_add_assignee_reviewers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">stage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> set up merge request</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> read LAST_MR_ID &lt; &lt;(curl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">header "PRIVATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$TOKEN" "$PROJECT_URL" </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq '.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> .iid')</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> read MR_AUTHOR &lt; &lt;(curl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">header "PRIVATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$TOKEN" "$PROJECT_URL/$LAST_MR_ID" </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq '.author </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> .id')</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add assignee</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> curl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">s </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">request PUT </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">header "PRIVATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$TOKEN" "$PROJECT_URL/$LAST_MR_ID" </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">form "assignee_ids=$MR_AUTHOR" </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token plain"> jq '.assignees'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># add reviewers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> curl </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">s </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">request PUT </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">header "PRIVATE</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">$TOKEN" "$PROJECT_URL/$LAST_MR_ID" </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">form "reviewer_ids=$REVIEWERS"</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-python-gitlab-api">3. Python gitlab API<a href="https://akmalov.com/blog/gitlab-auto-reviewers#3-python-gitlab-api" class="hash-link" aria-label="Прямая ссылка на 3. Python gitlab API" title="Прямая ссылка на 3. Python gitlab API">​</a></h2>
<p>Данный вариант более гибкий и удобный в плане доработок под разные условия.
Есть так же возможность вызывать как python script в <code>gitlab-ci</code></p>
<p>Полный код на <a href="https://github.com/akmalovaa/gitlab-auto-add-reviewers/tree/master/Python" target="_blank" rel="noopener noreferrer">github</a></p>
<p>Python/settings.py</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">GITLAB_API_ADDR </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'&lt;https://gitlab.com&gt;'</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Your Gitlab URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">GITLAB_TOKEN</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">'YOUR GITLAB API TOKEN'</span><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># API Token use import .env</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">GITLAB_ROOT_GROUP </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">''</span><span class="token plain">                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Root Group optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">GITLAB_REVIEWERS</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(130, 170, 255)">list</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">10043654</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">         </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Gitlab Reviewrs ID</span><br></span></code></pre></div></div>
<p>Python/main.py</p>
<div class="language-Python language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> gitlab</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> settings</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">import</span><span class="token plain"> typing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">gl </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GITLAB_API_ADDR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> private_token</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">settings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GITLAB_TOKEN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">get_last_merge_requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">None</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:rgb(195, 232, 141)">""" Get last merg request """</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> settings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GITLAB_ROOT_GROUP </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">''</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        all_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> typing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Any </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">mergerequests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">state</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">"opened"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">else</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        all_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> typing</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Any </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">groups</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">settings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GITLAB_ROOT_GROUP</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">mergerequests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token builtin" style="color:rgb(130, 170, 255)">list</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">state</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">"opened"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        last_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">v4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">merge_requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">MergeRequest </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> all_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">except</span><span class="token plain"> IndexError</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">"Merge requests - Not found"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    _auto_add_responsible</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">last_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">_auto_add_responsible</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">v4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">merge_requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GroupMergeRequest</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">None</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    project</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">v4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Project </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> gl</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">projects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">project_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> lazy</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    editable_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> gitlab</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">v4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">objects</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">merge_requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">ProjectMergeRequest </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        project</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">mergerequests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">iid</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> lazy</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token boolean" style="color:rgb(255, 88, 116)">True</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    editable_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">assignee_id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">author</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">"id"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    editable_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">reviewer_ids </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> settings</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">GITLAB_REVIEWERS</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">print</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">editable_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    editable_mr</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"__main__"</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    get_last_merge_requests</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre></div></div>
<p>example for <code>.gitlab-ci.yml</code></p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">.python_add_reviewers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> pip install virtualenv</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> virtualenv venv</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> source venv/bin/activate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> pip install </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r Python/requirements.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> python Python/main.py</span><br></span></code></pre></div></div>]]></content:encoded>
            <category>gitlab</category>
            <category>devops</category>
            <category>bash</category>
            <category>python</category>
        </item>
        <item>
            <title><![CDATA[Мониторинг для компьютерного клуба]]></title>
            <link>https://akmalov.com/blog/monitoring-pc-club</link>
            <guid>https://akmalov.com/blog/monitoring-pc-club</guid>
            <pubDate>Sun, 28 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[Система мониторинга в компьютерном клубе]]></description>
            <content:encoded><![CDATA[<p>Система мониторинга дает возможность отслеживать и оперативно узнавать об ошибках в работе и общей нагрузке на оборудование.</p>
<p><a href="https://akmalov.com/blog/monitoring-pc-club"><img decoding="async" loading="lazy" alt="Releases update info" src="https://akmalov.com/assets/images/monitoring-pc-club-037f03ec2b5601108df6ba3e3bccce1c.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="зачем-мониторинг">Зачем мониторинг?<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%B7%D0%B0%D1%87%D0%B5%D0%BC-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3" class="hash-link" aria-label="Прямая ссылка на Зачем мониторинг?" title="Прямая ссылка на Зачем мониторинг?">​</a></h2>
<p>Благодаря мониторингу можно увидеть полноценную картину использования и работоспособности оборудования.</p>
<p>Позволяет многие технические проблемы решать до их проявления и улучшать качество обслуживания пользователей.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="что-мониторить">Что мониторить?<a href="https://akmalov.com/blog/monitoring-pc-club#%D1%87%D1%82%D0%BE-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%82%D1%8C" class="hash-link" aria-label="Прямая ссылка на Что мониторить?" title="Прямая ссылка на Что мониторить?">​</a></h2>
<ul>
<li>CPU (нагрузка на процессор, температура)</li>
<li>GPU (нагрузка на видеокарту, температура)</li>
<li>RAM (нагрузка на оперативную память)</li>
<li>SSD, HDD (состояние дисков, свободный объем)</li>
<li>Любая другая полезная информация, которую необходимо вывести</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="как-мониторить">Как мониторить?<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%BA%D0%B0%D0%BA-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%82%D1%8C" class="hash-link" aria-label="Прямая ссылка на Как мониторить?" title="Прямая ссылка на Как мониторить?">​</a></h2>
<p>Основная связка Prometheus + Grafana</p>
<p>Это самые популярные сервисы для мониторинга, быстрые и удобные</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="prometheus">Prometheus<a href="https://akmalov.com/blog/monitoring-pc-club#prometheus" class="hash-link" aria-label="Прямая ссылка на Prometheus" title="Прямая ссылка на Prometheus">​</a></h3>
<p>Собирает и хранит все метрики. Сам ходит к каждому компьютеры и собирает нужную информацию</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grafana">Grafana<a href="https://akmalov.com/blog/monitoring-pc-club#grafana" class="hash-link" aria-label="Прямая ссылка на Grafana" title="Прямая ссылка на Grafana">​</a></h3>
<p>Берет  данные с Prometheus и позволяет красиво все отобразить. Главная панель мониторинга</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exporters">Exporters<a href="https://akmalov.com/blog/monitoring-pc-club#exporters" class="hash-link" aria-label="Прямая ссылка на Exporters" title="Прямая ссылка на Exporters">​</a></h3>
<p><strong>Экспортер</strong> - представляет собой службу, которая собирает информацию о системе и подготавливает ее в формате понятным для Prometheus. На каждом компьютере с которого нужная информация, должен быть запущен exporter</p>
<p><img decoding="async" loading="lazy" alt="monitoring" src="https://akmalov.com/assets/images/monitoring-cff136765f316f2616afe51fab89adb4.jpg" width="3000" height="2000" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка-сервера">Подготовка сервера<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0" class="hash-link" aria-label="Прямая ссылка на Подготовка сервера" title="Прямая ссылка на Подготовка сервера">​</a></h2>
<p>Сервер или виртуалка с Linux (я использовал Ubuntu но для docker разницы нет)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="docker-compose">docker-compose<a href="https://akmalov.com/blog/monitoring-pc-club#docker-compose" class="hash-link" aria-label="Прямая ссылка на docker-compose" title="Прямая ссылка на docker-compose">​</a></h3>
<p>Для удобства обслуживания будет использоваться docker-compose</p>
<div class="language-YAML language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">"3.7"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">prometheus</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prom/prometheus</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">v2.44.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">command</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--config.file=/etc/prometheus/prometheus.yml'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--storage.tsdb.path=/prometheus'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--web.console.libraries=/etc/prometheus/console_libraries'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--web.console.templates=/etc/prometheus/consoles'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--storage.tsdb.retention.time=30d'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--web.enable-lifecycle'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">'--web.external-url=https://prom.akmalov.com'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> TZ="Asia/Yekaterinburg"</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> 9090</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">9090</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./prometheus/config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/etc/prometheus/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./prometheus/data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/prometheus/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">stopped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">grafana</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> grafana/grafana</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">9.5.3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">ubuntu</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">container_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> grafana</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">depends_on</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> prometheus</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> 3000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">volumes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./grafana/data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/var/lib/grafana</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ./grafana/provisioning</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">/etc/grafana/provisioning</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">environment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GF_SECURITY_ADMIN_USER=admin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GF_SECURITY_ADMIN_PASSWORD=12345</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GF_USERS_ALLOW_SIGN_UP=false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> TZ="Asia/Yekaterinburg"</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> BROWSER_TZ="Asia/Yekaterinburg"</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">restart</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> unless</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">stopped</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="конфигурация-prometheus">Конфигурация prometheus<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F-prometheus" class="hash-link" aria-label="Прямая ссылка на Конфигурация prometheus" title="Прямая ссылка на Конфигурация prometheus">​</a></h3>
<p>Создать файл конфига по пути:
<code>./prometheus/config/prometheus.yml </code></p>
<p>В данном примере добавлены 5 ПК, отдельные job для Windows и GPU экспортеров</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">global:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  scrape_interval:     15s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  evaluation_interval: 15s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - job_name: 'GPU'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    metrics_path: '/metrics'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    scrape_interval: 5s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.11:9835</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.12:9835</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.13:9835</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.14:9835</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.15:9835</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          metrics: nvidia</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - job_name: 'Windows'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    metrics_path: '/metrics'</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    scrape_interval: 5s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    static_configs:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - targets:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.11:9182</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.12:9182</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.13:9182</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.14:9182</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - 192.168.18.15:9182</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          metrics: OS</span><br></span></code></pre></div></div>
<p>Создание config файла можно сильно упросить и автоматизировать с помощью Ansible</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="подготовка-компьютеров">Подготовка компьютеров<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%BF%D0%BE%D0%B4%D0%B3%D0%BE%D1%82%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BC%D0%BF%D1%8C%D1%8E%D1%82%D0%B5%D1%80%D0%BE%D0%B2" class="hash-link" aria-label="Прямая ссылка на Подготовка компьютеров" title="Прямая ссылка на Подготовка компьютеров">​</a></h2>
<p>В данном случаи понадобиться установить два экспортера:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="windows-exporter"><a href="https://github.com/prometheus-community/windows_exporter" target="_blank" rel="noopener noreferrer">windows exporter</a><a href="https://akmalov.com/blog/monitoring-pc-club#windows-exporter" class="hash-link" aria-label="Прямая ссылка на windows-exporter" title="Прямая ссылка на windows-exporter">​</a></h3>
<p><a href="https://github.com/prometheus-community/windows_exporter" target="_blank" rel="noopener noreferrer">Windows Exporter</a> - позволяет мониторить состояние операционной системы Windows и собирать метрики для дальнейшей обработки, выводит различные параметры и характеристики Windows, такие как:</p>
<ul>
<li>Использование процессора и памяти;</li>
<li>Загрузка дисков и средств хранения;</li>
<li>Статистика сетевых интерфейсов;</li>
<li>Статистика работы служб и сервисов Windows;</li>
<li>Информация о запущенных процессах и открытых сокетах;</li>
<li>Информация о состоянии производительности IIS и многие другие параметры.</li>
</ul>
<p>Использование Windows Exporter позволяет проводить мониторинг и анализ состояния Windows и быстро реагировать на возможные проблемы, такие как ограниченная производительность, низкая доступность ресурсов и другие. Благодаря этому инструменту можно повысить стабильность и надежность работы системы Windows, а также улучшить качество обслуживания пользователей.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nvidia-gpu-exporter"><a href="https://github.com/utkuozdemir/nvidia_gpu_exporter" target="_blank" rel="noopener noreferrer">nvidia gpu exporter</a><a href="https://akmalov.com/blog/monitoring-pc-club#nvidia-gpu-exporter" class="hash-link" aria-label="Прямая ссылка на nvidia-gpu-exporter" title="Прямая ссылка на nvidia-gpu-exporter">​</a></h3>
<p><a href="https://github.com/utkuozdemir/nvidia_gpu_exporter" target="_blank" rel="noopener noreferrer">Nvidia GPU exporter</a> - позволяет получать всю информация о видеокарте</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="настройка-grafana">Настройка Grafana<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-grafana" class="hash-link" aria-label="Прямая ссылка на Настройка Grafana" title="Прямая ссылка на Настройка Grafana">​</a></h2>
<p>Далее необходимо настроить Grafana (WEB интерфейс доступен по адресу сервера c docker на порту 3000)</p>
<p><code>Configuration -&gt; Data source -&gt; Add Prometheus</code></p>
<p><img decoding="async" loading="lazy" alt="grafana data source" src="https://akmalov.com/assets/images/grafana-data-source-73b1db732b3995f3c7097d0eca430211.png" width="1736" height="866" class="img_ev3q"></p>
<p>Для того чтобы убедиться что все работает корректно, можно скачать и добавить готовые dashboard в графана</p>
<ul>
<li><a href="https://grafana.com/grafana/dashboards/14694-windows-exporter-dashboard/" target="_blank" rel="noopener noreferrer">Windows exporter dashboard</a></li>
<li><a href="https://grafana.com/grafana/dashboards/14574-nvidia-gpu-metrics/" target="_blank" rel="noopener noreferrer">Nvidia GPU dashboard</a></li>
</ul>
<p><code>Dashboard -&gt; Import -&gt; JSON file</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="windows-exporter-dashboard">Windows exporter dashboard<a href="https://akmalov.com/blog/monitoring-pc-club#windows-exporter-dashboard" class="hash-link" aria-label="Прямая ссылка на Windows exporter dashboard" title="Прямая ссылка на Windows exporter dashboard">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Windows exporter dashboard" src="https://akmalov.com/assets/images/windows-exporter-0897beaf7126eb7b069ea7419b0eefcb.png" width="1919" height="922" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nvidia-gpu-exporter-dashboard">Nvidia GPU exporter dashboard<a href="https://akmalov.com/blog/monitoring-pc-club#nvidia-gpu-exporter-dashboard" class="hash-link" aria-label="Прямая ссылка на Nvidia GPU exporter dashboard" title="Прямая ссылка на Nvidia GPU exporter dashboard">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Nvidia GPU exporter dashboard" src="https://akmalov.com/assets/images/nvidia-gpu-exporter-d1f9965ae1cadfc7f593b1a3dd2258bc.png" width="3360" height="1744" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="создание-собственной-панели-мониторинга">Создание собственной панели мониторинга<a href="https://akmalov.com/blog/monitoring-pc-club#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%B9-%D0%BF%D0%B0%D0%BD%D0%B5%D0%BB%D0%B8-%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%D0%B0" class="hash-link" aria-label="Прямая ссылка на Создание собственной панели мониторинга" title="Прямая ссылка на Создание собственной панели мониторинга">​</a></h2>
<p>Теперь осталась создать свой dashboard и собрать в удобном виде все необходимые метрики</p>
<p>Для себя выбрал следующий тип отображения (в одну линию все необходимые данные)</p>
<p><img decoding="async" loading="lazy" alt="grafana pc dashboard" src="https://akmalov.com/assets/images/grafana-pc-monitoirng-9599a8eb47160e6088bbee8660f05b4c.png" width="1868" height="932" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="итоги">Итоги<a href="https://akmalov.com/blog/monitoring-pc-club#%D0%B8%D1%82%D0%BE%D0%B3%D0%B8" class="hash-link" aria-label="Прямая ссылка на Итоги" title="Прямая ссылка на Итоги">​</a></h2>
<p>Prometheus и Grafana дают возможность настроить удобный монитиринг для компьютерного клуба.
Легко установить, использовать, обслуживать.</p>
<p>Для большого числа компьютеров удобнее использовать Ansible для автоматической установки экспортеров и подготовки конфигурационного файла с помощью шаблонизатора.</p>
<p>Так же экспортеры можно встроить в установку с операционной системой, в таком случаи все новые компьютеры автоматически будут попопадть в систему мониторинга.</p>]]></content:encoded>
            <category>docker</category>
            <category>monitoring</category>
        </item>
        <item>
            <title><![CDATA[Releases info]]></title>
            <link>https://akmalov.com/blog/releases-info</link>
            <guid>https://akmalov.com/blog/releases-info</guid>
            <pubDate>Mon, 15 May 2023 00:00:00 GMT</pubDate>
            <description><![CDATA[releases check latest version]]></description>
            <content:encoded><![CDATA[<p>Решение для проверки последних релизных версий. Готовый docker файл, написан с использованием Python, Flask</p>
<p><a href="https://akmalov.com/blog/releases-info"><img decoding="async" loading="lazy" alt="Releases update info" src="https://akmalov.com/assets/images/update-releases-028b9980ce7a103dfb783076f0b2716c.png" width="1500" height="500" class="img_ev3q"></a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="releases-info">Releases info<a href="https://akmalov.com/blog/releases-info#releases-info" class="hash-link" aria-label="Прямая ссылка на Releases info" title="Прямая ссылка на Releases info">​</a></h2>
<p>Страница на <a href="https://github.com/akmalovaa/releases-info" target="_blank" rel="noopener noreferrer">Github</a></p>
<p>Сервис проверяет новые версии ваших проектов и показывает, отставание от последних релизов
<img decoding="async" loading="lazy" alt="Releases info" src="https://akmalov.com/assets/images/example-fe614d38594ec87643d3873e58f42f70.png" width="1389" height="612" class="img_ev3q"></p>
<p>На данный момент проверка только с github проектов, где есть релизный список, планируется добавить проверку версий образов с <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker hub</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="запуск">Запуск<a href="https://akmalov.com/blog/releases-info#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA" class="hash-link" aria-label="Прямая ссылка на Запуск" title="Прямая ссылка на Запуск">​</a></h2>
<p>Скопировать .env.example в .env файл и вставить свой github token (нужен для обращения к github API)</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cp .env.example .env</span><br></span></code></pre></div></div>
<p>Запустить docker-compose</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">docker-compose up -d</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="настройка">Настройка<a href="https://akmalov.com/blog/releases-info#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0" class="hash-link" aria-label="Прямая ссылка на Настройка" title="Прямая ссылка на Настройка">​</a></h2>
<p>Необходимо изменить файл config.yml:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">services</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">sentry</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">github</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">owner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> getsentry</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">repo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sentry</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> 22.11.0</span><br></span></code></pre></div></div>
<p>Например ссылка <a href="https://github.com/getsentry/sentry" target="_blank" rel="noopener noreferrer">https://github.com/getsentry/sentry</a></p>
<ul>
<li>owner (владелец) - getsentry</li>
<li>repo (репозиторий) - sentry</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="планы">Планы<a href="https://akmalov.com/blog/releases-info#%D0%BF%D0%BB%D0%B0%D0%BD%D1%8B" class="hash-link" aria-label="Прямая ссылка на Планы" title="Прямая ссылка на Планы">​</a></h2>
<ul>
<li>Добавить проверку обновлений Docker HUB</li>
<li>Уведомления в Telegram о новых релизах</li>
<li>Автоматический парсинг версии с iac</li>
<li>Улучшить интерфейс, попробовать React</li>
<li>Подумать насчет базы данных</li>
</ul>]]></content:encoded>
            <category>docker</category>
            <category>python</category>
            <category>flask</category>
            <category>releases</category>
            <category>kubernetes</category>
        </item>
    </channel>
</rss>